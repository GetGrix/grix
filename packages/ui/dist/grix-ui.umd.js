(function(X,y){typeof exports=="object"&&typeof module<"u"?y(exports,require("react")):typeof define=="function"&&define.amd?define(["exports","react"],y):(X=typeof globalThis<"u"?globalThis:X||self,y(X.GrixUI={},X.React))})(this,function(X,y){"use strict";var ut=Object.defineProperty;var xt=(X,y,se)=>y in X?ut(X,y,{enumerable:!0,configurable:!0,writable:!0,value:se}):X[y]=se;var Q=(X,y,se)=>xt(X,typeof y!="symbol"?y+"":y,se);var se={exports:{}},de={};/**
 * @license React
 * react-jsx-runtime.production.js
 *
 * Copyright (c) Meta Platforms, Inc. and affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var be;function Le(){if(be)return de;be=1;var t=Symbol.for("react.transitional.element"),e=Symbol.for("react.fragment");function s(i,o,r){var c=null;if(r!==void 0&&(c=""+r),o.key!==void 0&&(c=""+o.key),"key"in o){r={};for(var d in o)d!=="key"&&(r[d]=o[d])}else r=o;return o=r.ref,{$$typeof:t,type:i,key:c,ref:o!==void 0?o:null,props:r}}return de.Fragment=e,de.jsx=s,de.jsxs=s,de}var he={};/**
 * @license React
 * react-jsx-runtime.development.js
 *
 * Copyright (c) Meta Platforms, Inc. and affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var ve;function We(){return ve||(ve=1,process.env.NODE_ENV!=="production"&&function(){function t(u){if(u==null)return null;if(typeof u=="function")return u.$$typeof===k?null:u.displayName||u.name||null;if(typeof u=="string")return u;switch(u){case w:return"Fragment";case h:return"Profiler";case a:return"StrictMode";case P:return"Suspense";case N:return"SuspenseList";case C:return"Activity"}if(typeof u=="object")switch(typeof u.tag=="number"&&console.error("Received an unexpected object in getComponentNameFromType(). This is likely a bug in React. Please file an issue."),u.$$typeof){case p:return"Portal";case b:return(u.displayName||"Context")+".Provider";case g:return(u._context.displayName||"Context")+".Consumer";case v:var A=u.render;return u=u.displayName,u||(u=A.displayName||A.name||"",u=u!==""?"ForwardRef("+u+")":"ForwardRef"),u;case E:return A=u.displayName||null,A!==null?A:t(u.type)||"Memo";case _:A=u._payload,u=u._init;try{return t(u(A))}catch{}}return null}function e(u){return""+u}function s(u){try{e(u);var A=!1}catch{A=!0}if(A){A=console;var Y=A.error,m=typeof Symbol=="function"&&Symbol.toStringTag&&u[Symbol.toStringTag]||u.constructor.name||"Object";return Y.call(A,"The provided key is an unsupported type %s. This value must be coerced to a string before using it here.",m),e(u)}}function i(u){if(u===w)return"<>";if(typeof u=="object"&&u!==null&&u.$$typeof===_)return"<...>";try{var A=t(u);return A?"<"+A+">":"<...>"}catch{return"<...>"}}function o(){var u=q.A;return u===null?null:u.getOwner()}function r(){return Error("react-stack-top-frame")}function c(u){if(U.call(u,"key")){var A=Object.getOwnPropertyDescriptor(u,"key").get;if(A&&A.isReactWarning)return!1}return u.key!==void 0}function d(u,A){function Y(){Z||(Z=!0,console.error("%s: `key` is not a prop. Trying to access it will result in `undefined` being returned. If you need to access the same value within the child component, you should pass it as a different prop. (https://react.dev/link/special-props)",A))}Y.isReactWarning=!0,Object.defineProperty(u,"key",{get:Y,configurable:!0})}function x(){var u=t(this.type);return ne[u]||(ne[u]=!0,console.error("Accessing element.ref was removed in React 19. ref is now a regular prop. It will be removed from the JSX Element type in a future release.")),u=this.props.ref,u!==void 0?u:null}function f(u,A,Y,m,S,D,W,B){return Y=D.ref,u={$$typeof:l,type:u,key:A,props:D,_owner:S},(Y!==void 0?Y:null)!==null?Object.defineProperty(u,"ref",{enumerable:!1,get:x}):Object.defineProperty(u,"ref",{enumerable:!1,value:null}),u._store={},Object.defineProperty(u._store,"validated",{configurable:!1,enumerable:!1,writable:!0,value:0}),Object.defineProperty(u,"_debugInfo",{configurable:!1,enumerable:!1,writable:!0,value:null}),Object.defineProperty(u,"_debugStack",{configurable:!1,enumerable:!1,writable:!0,value:W}),Object.defineProperty(u,"_debugTask",{configurable:!1,enumerable:!1,writable:!0,value:B}),Object.freeze&&(Object.freeze(u.props),Object.freeze(u)),u}function M(u,A,Y,m,S,D,W,B){var $=A.children;if($!==void 0)if(m)if(H($)){for(m=0;m<$.length;m++)j($[m]);Object.freeze&&Object.freeze($)}else console.error("React.jsx: Static children should always be an array. You are likely explicitly calling React.jsxs or React.jsxDEV. Use the Babel transform instead.");else j($);if(U.call(A,"key")){$=t(u);var K=Object.keys(A).filter(function(O){return O!=="key"});m=0<K.length?"{key: someKey, "+K.join(": ..., ")+": ...}":"{key: someKey}",ie[$+m]||(K=0<K.length?"{"+K.join(": ..., ")+": ...}":"{}",console.error(`A props object containing a "key" prop is being spread into JSX:
  let props = %s;
  <%s {...props} />
React keys must be passed directly to JSX without using spread:
  let props = %s;
  <%s key={someKey} {...props} />`,m,$,K,$),ie[$+m]=!0)}if($=null,Y!==void 0&&(s(Y),$=""+Y),c(A)&&(s(A.key),$=""+A.key),"key"in A){Y={};for(var ee in A)ee!=="key"&&(Y[ee]=A[ee])}else Y=A;return $&&d(Y,typeof u=="function"?u.displayName||u.name||"Unknown":u),f(u,$,D,S,o(),Y,W,B)}function j(u){typeof u=="object"&&u!==null&&u.$$typeof===l&&u._store&&(u._store.validated=1)}var F=y,l=Symbol.for("react.transitional.element"),p=Symbol.for("react.portal"),w=Symbol.for("react.fragment"),a=Symbol.for("react.strict_mode"),h=Symbol.for("react.profiler"),g=Symbol.for("react.consumer"),b=Symbol.for("react.context"),v=Symbol.for("react.forward_ref"),P=Symbol.for("react.suspense"),N=Symbol.for("react.suspense_list"),E=Symbol.for("react.memo"),_=Symbol.for("react.lazy"),C=Symbol.for("react.activity"),k=Symbol.for("react.client.reference"),q=F.__CLIENT_INTERNALS_DO_NOT_USE_OR_WARN_USERS_THEY_CANNOT_UPGRADE,U=Object.prototype.hasOwnProperty,H=Array.isArray,T=console.createTask?console.createTask:function(){return null};F={"react-stack-bottom-frame":function(u){return u()}};var Z,ne={},le=F["react-stack-bottom-frame"].bind(F,r)(),re=T(i(r)),ie={};he.Fragment=w,he.jsx=function(u,A,Y,m,S){var D=1e4>q.recentlyCreatedOwnerStacks++;return M(u,A,Y,!1,m,S,D?Error("react-stack-top-frame"):le,D?T(i(u)):re)},he.jsxs=function(u,A,Y,m,S){var D=1e4>q.recentlyCreatedOwnerStacks++;return M(u,A,Y,!0,m,S,D?Error("react-stack-top-frame"):le,D?T(i(u)):re)}}()),he}var je;function _e(){return je||(je=1,process.env.NODE_ENV==="production"?se.exports=Le():se.exports=We()),se.exports}var n=_e();const ae={distance(t,e){const s=e.x-t.x,i=e.y-t.y;return Math.sqrt(s*s+i*i)},slope(t,e){const s=e.x-t.x,i=e.y-t.y;return Math.abs(s)<Number.EPSILON?s===0||s>0?1/0:-1/0:i/s},angle(t,e){const s=e.x-t.x,i=e.y-t.y;return Math.atan2(i,s)},magnitude(t){return Math.sqrt(t.x*t.x+t.y*t.y)},normalize(t){const e=this.magnitude(t);return e===0?{x:0,y:0}:{x:t.x/e,y:t.y/e}},snapToGrid(t,e){return{x:Math.round(t.x/e)*e,y:Math.round(t.y/e)*e}},calculateArea(t){return Math.abs(t.properties.width*t.properties.height)},boundsContainPoint(t,e){return e.x>=t.x&&e.x<=t.x+t.width&&e.y>=t.y&&e.y<=t.y+t.height},boundsIntersect(t,e){return!(t.x+t.width<e.x||e.x+e.width<t.x||t.y+t.height<e.y||e.y+e.height<t.y)},gcd(t,e){for(t=Math.abs(t),e=Math.abs(e);e!==0;){const s=e;e=t%e,t=s}return t},simplifyFraction(t,e){if(e===0)return[t,1];const s=this.gcd(t,e);return[t/s,e/s]},worldToScreen(t,e,s){const i=s.width/2,o=s.height/2,r=(t.x-e.center.x)*e.zoom,c=(t.y-e.center.y)*e.zoom;return{x:i+r,y:o-c}},screenToWorld(t,e,s){const i=s.width/2,o=s.height/2,r=(t.x-i)/e.zoom,c=(o-t.y)/e.zoom;return{x:e.center.x+r,y:e.center.y+c}}},ce={detectCapabilities(){const t="ontouchstart"in window||navigator.maxTouchPoints>0,e=t&&navigator.maxTouchPoints>1,s=!0,i=window.matchMedia("(hover: hover)").matches;return{hasTouch:t,hasPencil:e,hasKeyboard:s,hasHover:i,maxTouchPoints:navigator.maxTouchPoints||0,supportsPressure:"force"in Touch.prototype,supportsTilt:"altitudeAngle"in Touch.prototype}},normalizePointerEvent(t){let e="mouse";return t.pointerType==="touch"?e="touch":t.pointerType==="pen"&&(e="pen"),{type:e,pressure:t.pressure||0,tiltX:t.tiltX||0,tiltY:t.tiltY||0,x:t.clientX,y:t.clientY,timestamp:t.timeStamp,isPrimary:t.isPrimary,pointerId:t.pointerId}},getTouchTargetSize(t){switch(t){case"pen":return 32;case"touch":return 44;case"mouse":return 24;default:return 44}}};class Ye{constructor(){this.listeners=new Map}on(e,s){this.listeners.has(e)||this.listeners.set(e,[]),this.listeners.get(e).push(s)}off(e,s){const i=this.listeners.get(e);if(i){const o=i.indexOf(s);o>-1&&i.splice(o,1)}}emit(e,s){const i=this.listeners.get(e);i&&i.forEach(o=>{try{o(s)}catch(r){console.error(`Error in event handler for ${e}:`,r)}})}clear(){this.listeners.clear()}getEvents(){return Array.from(this.listeners.keys())}getListenerCount(e){var s;return((s=this.listeners.get(e))==null?void 0:s.length)||0}}const Me=t=>{let e;const s=new Set,i=(f,M)=>{const j=typeof f=="function"?f(e):f;if(!Object.is(j,e)){const F=e;e=M??(typeof j!="object"||j===null)?j:Object.assign({},e,j),s.forEach(l=>l(e,F))}},o=()=>e,d={setState:i,getState:o,getInitialState:()=>x,subscribe:f=>(s.add(f),()=>s.delete(f))},x=e=t(i,o,d);return d},Ge=t=>t?Me(t):Me,Be=t=>t;function Xe(t,e=Be){const s=y.useSyncExternalStore(t.subscribe,()=>e(t.getState()),()=>e(t.getInitialState()));return y.useDebugValue(s),s}const Pe=t=>{const e=Ge(t),s=i=>Xe(e,i);return Object.assign(s,e),s},fe=t=>t?Pe(t):Pe,V=fe((t,e)=>({viewport:{center:{x:0,y:0},zoom:20,bounds:{x:-10,y:-10,width:20,height:20}},objects:[],selectedObjects:[],snapToGrid:!0,gridDensity:"fine",canvasSize:{width:800,height:600},setViewport:s=>{t(i=>({viewport:{...i.viewport,...s}}))},addObject:s=>{t(i=>({objects:[...i.objects,s]}))},removeObject:s=>{t(i=>({objects:i.objects.filter(o=>o.id!==s),selectedObjects:i.selectedObjects.filter(o=>o!==s)}))},updateObject:(s,i)=>{t(o=>({objects:o.objects.map(r=>r.id===s?{...r,...i}:r)}))},selectObject:(s,i=!1)=>{t(o=>i?{selectedObjects:o.selectedObjects.includes(s)?o.selectedObjects.filter(c=>c!==s):[...o.selectedObjects,s]}:{selectedObjects:[s]})},clearSelection:()=>{t({selectedObjects:[]})},setSnapToGrid:s=>{t({snapToGrid:s})},setGridDensity:s=>{t({gridDensity:s})},setCanvasSize:s=>{t({canvasSize:s})},getObject:s=>e().objects.find(i=>i.id===s),getAllObjects:()=>e().objects,getSelectedObjects:()=>{const s=e();return s.objects.filter(i=>s.selectedObjects.includes(i.id))},screenToWorld:s=>{const{viewport:i,canvasSize:o}=e();return ae.screenToWorld(s,i,o)},worldToScreen:s=>{const{viewport:i,canvasSize:o}=e();return ae.worldToScreen(s,i,o)}})),qe=()=>({addObject:t=>V.getState().addObject(t),removeObject:t=>V.getState().removeObject(t),updateObject:(t,e)=>V.getState().updateObject(t,e),getObject:t=>V.getState().getObject(t),getAllObjects:()=>V.getState().getAllObjects(),screenToWorld:t=>V.getState().screenToWorld(t),worldToScreen:t=>V.getState().worldToScreen(t)}),Ue=()=>({getState:()=>{const t=V.getState();return{viewport:t.viewport,objects:t.objects,selectedObjects:t.selectedObjects,snapToGrid:t.snapToGrid,gridDensity:t.gridDensity}},setState:t=>{V.setState(t)},subscribe:t=>V.subscribe(e=>{t({viewport:e.viewport,objects:e.objects,selectedObjects:e.selectedObjects,snapToGrid:e.snapToGrid,gridDensity:e.gridDensity})})}),we=y.createContext(null);function ue(){const t=y.useContext(we);if(!t)throw new Error("usePluginManager must be used within PluginManagerProvider");return t}function Se({children:t}){const[e]=y.useState(()=>new Ye),[s]=y.useState(()=>new Map),[i]=y.useState(()=>new Map),[o,r]=y.useState(null),c=y.useRef(),d=y.useRef(),x=y.useRef();c.current||(c.current=qe()),d.current||(d.current=Ue()),x.current||(x.current={distance:ae.distance,slope:ae.slope,snapToGrid:ae.snapToGrid,calculateArea:ae.calculateArea});const f=c.current,M=d.current,j=x.current,F=a=>{if(s.has(a.id)){console.warn(`Plugin ${a.id} is already registered`);return}const h={canvas:f,events:e,state:M,math:j};s.set(a.id,a),i.set(a.id,h);try{a.init(h),console.log(`Plugin ${a.id} initialized successfully`)}catch(g){console.error(`Failed to initialize plugin ${a.id}:`,g),s.delete(a.id),i.delete(a.id)}},l=a=>{var g;const h=s.get(a);if(h){try{(g=h.destroy)==null||g.call(h)}catch(b){console.error(`Error destroying plugin ${a}:`,b)}s.delete(a),i.delete(a),o===a&&r(null)}},p=()=>Array.from(s.values());y.useEffect(()=>{e.emit("tool:changed",{previous:null,current:o})},[o,e]),y.useEffect(()=>{const a=v=>P=>{var E,_,C,k,q,U;const N=o?s.get(o):null;if(N)try{switch(v){case"pointer:down":(E=N.onPointerDown)==null||E.call(N,P);break;case"pointer:move":(_=N.onPointerMove)==null||_.call(N,P);break;case"pointer:up":(C=N.onPointerUp)==null||C.call(N,P);break}}catch(H){console.error(`Error in plugin ${o} handling ${v}:`,H)}else{const H=M.getState().selectedObjects;try{let T;if(H.length===1){const Z=f.getObject(H[0]);(Z==null?void 0:Z.type)==="ray"?T=s.get("ray-tool"):(Z==null?void 0:Z.type)==="rectangle"&&(T=s.get("rectangle-tool"))}if(T)switch(v){case"pointer:down":(k=T.onPointerDown)==null||k.call(T,P);break;case"pointer:move":(q=T.onPointerMove)==null||q.call(T,P);break;case"pointer:up":(U=T.onPointerUp)==null||U.call(T,P);break}}catch(T){console.error(`Error in tool handling ${v} for manipulation:`,T)}}},h=a("pointer:down"),g=a("pointer:move"),b=a("pointer:up");return e.on("pointer:down",h),e.on("pointer:move",g),e.on("pointer:up",b),()=>{e.off("pointer:down",h),e.off("pointer:move",g),e.off("pointer:up",b)}},[o,s,e]);const w={eventBus:e,registerPlugin:F,unregisterPlugin:l,getActivePlugins:p,activeTool:o,setActiveTool:r};return n.jsx(we.Provider,{value:w,children:t})}function He(){const{eventBus:t}=ue();return{handlePointerDown:o=>{t.emit("pointer:down",o)},handlePointerMove:o=>{t.emit("pointer:move",o)},handlePointerUp:o=>{t.emit("pointer:up",o)}}}function Ee(t,e,s={}){const[i,o]=y.useState(null),[r,c]=y.useState(new Map),d={enableGestures:!0,touchTargetSize:44,preventScrolling:!0,...s};y.useEffect(()=>{const a=ce.detectCapabilities();o(a)},[]);const[x,f]=y.useState({isGesturing:!1,startTime:0,startDistance:0,lastTapTime:0,tapCount:0}),M=y.useCallback(a=>{const h=Array.from(a.values());if(h.length<2)return 0;const g=h[0],b=h[1];if(!g||!b)return 0;const v=g.x-b.x,P=g.y-b.y;return Math.sqrt(v*v+P*P)},[]),j=y.useCallback(a=>{const h=Array.from(a.values());if(h.length===0)return{x:0,y:0};const g=h.reduce((b,v)=>({x:b.x+v.x,y:b.y+v.y}),{x:0,y:0});return{x:g.x/h.length,y:g.y/h.length}},[]),F=y.useCallback(a=>{var P;if(!t.current)return;d.preventScrolling&&a.preventDefault();const h=t.current.getBoundingClientRect(),g=a.clientX-h.left,b=a.clientY-h.top,v=ce.normalizePointerEvent(a);v.x=g,v.y=b,c(N=>{const E=new Map(N);if(E.set(a.pointerId,v),d.enableGestures&&E.size>=2){const _=M(E);f(C=>({...C,isGesturing:!0,startTime:a.timeStamp,startDistance:_}))}return E}),t.current.setPointerCapture(a.pointerId),(P=e.onPointerDown)==null||P.call(e,v)},[t,e,d,M]),l=y.useCallback(a=>{var P;if(!t.current)return;const h=t.current.getBoundingClientRect(),g=a.clientX-h.left,b=a.clientY-h.top,v=ce.normalizePointerEvent(a);v.x=g,v.y=b,c(N=>{var _,C;const E=new Map(N);if(E.set(a.pointerId,v),d.enableGestures&&E.size>=2){const k=M(E),q=j(E);if(x.isGesturing&&x.startDistance>0){const U=k/x.startDistance;(_=e.onGesture)==null||_.call(e,{type:"pinch",center:q,scale:U,touches:E.size})}}else if(E.size===1&&x.isGesturing){const k=j(E);(C=e.onGesture)==null||C.call(e,{type:"pan",center:k,touches:E.size})}return E}),(P=e.onPointerMove)==null||P.call(e,v)},[e,d,M,j,x]),p=y.useCallback(a=>{var P;if(!t.current)return;const h=t.current.getBoundingClientRect(),g=a.clientX-h.left,b=a.clientY-h.top,v=ce.normalizePointerEvent(a);v.x=g,v.y=b,c(N=>{var _;const E=new Map(N);if(E.delete(a.pointerId),d.enableGestures&&E.size===0){const k=a.timeStamp-x.startTime<200,q=a.timeStamp-x.lastTapTime;k&&!x.isGesturing&&(q<300?f(U=>({...U,tapCount:U.tapCount+1})):((_=e.onGesture)==null||_.call(e,{type:"tap",center:{x:v.x,y:v.y},touches:1}),f(U=>({...U,tapCount:1,lastTapTime:a.timeStamp})))),f(U=>({...U,isGesturing:!1}))}return E}),t.current&&t.current.releasePointerCapture(a.pointerId),(P=e.onPointerUp)==null||P.call(e,v)},[t,e,d,x]),w=y.useCallback(a=>{var P;if(!t.current)return;const h=t.current.getBoundingClientRect(),g=a.clientX-h.left,b=a.clientY-h.top,v=ce.normalizePointerEvent(a);v.x=g,v.y=b,c(N=>{const E=new Map(N);return E.delete(a.pointerId),E}),f(N=>({...N,isGesturing:!1})),(P=e.onPointerCancel)==null||P.call(e,v)},[e]);return y.useEffect(()=>{const a=t.current;if(!a)return;a.addEventListener("pointerdown",F),a.addEventListener("pointermove",l),a.addEventListener("pointerup",p),a.addEventListener("pointercancel",w);const h=g=>g.preventDefault();return a.addEventListener("contextmenu",h),()=>{a.removeEventListener("pointerdown",F),a.removeEventListener("pointermove",l),a.removeEventListener("pointerup",p),a.removeEventListener("pointercancel",w),a.removeEventListener("contextmenu",h)}},[t,F,l,p,w]),{capabilities:i,activePointers:Array.from(r.values()),isGesturing:x.isGesturing,touchTargetSize:i?ce.getTouchTargetSize(i.hasTouch?"touch":"mouse"):d.touchTargetSize}}function Ce(t,e={minSpacing:8,maxSpacing:80,labelMinSpacing:40}){const s=t.zoom;let o=1,r=o*s;for(;r<e.minSpacing&&o<1e4;)o*=ke(o),r=o*s;for(;r>e.maxSpacing&&o>1e-4;)o/=Ze(o),r=o*s;let c=o,d=c*s;for(;d<e.labelMinSpacing&&c<o*100;)c*=ke(c),d=c*s;const x=Math.max(.1,Math.min(1,(r-e.minSpacing)/(e.maxSpacing-e.minSpacing)));return{gridSize:o,labelStep:c,shouldShowGrid:r>=e.minSpacing,shouldShowLabels:d>=e.labelMinSpacing,opacity:x}}function ke(t){if(t<1)return t>=.5?2:t>=.2?2.5:(t>=.1,2);if(t<10)return t>=5?2:t>=2?2.5:(t>=1,2);{const e=Math.pow(10,Math.floor(Math.log10(t))),s=t/e;return s>=5?2:s>=2?2.5:(s>=1,2)}}function Ze(t){if(t<=1)return t<=.1||t<=.2?2:t<=.5?2.5:(t<=1,2);if(t<=10)return t<=2?2:t<=5?2.5:(t<=10,2);{const e=Math.pow(10,Math.floor(Math.log10(t))),s=t/e;return s<=2?2:s<=5?2.5:(s<=10,2)}}function Ke(t,e,s,i,o=!0){const{gridSize:r}=s,c={left:t.center.x-e.width/2/t.zoom,right:t.center.x+e.width/2/t.zoom,top:t.center.y+e.height/2/t.zoom,bottom:t.center.y-e.height/2/t.zoom},d=[],x=[],f=Math.floor(c.left/r)*r,M=Math.ceil(c.right/r)*r;for(let l=f;l<=M;l+=r){const p=i({x:l,y:0}).x,w=Math.abs(l)<r/2,a=Math.abs(l%(r*5))<r/2;d.push({x:p,isAxis:w,isMajor:a,isInteger:!1,value:l})}if(r>=2&&o){const l=Math.floor(c.left),p=Math.ceil(c.right);for(let w=l;w<=p;w+=1)if(Math.abs(w%r)>.001){const a=i({x:w,y:0}).x,h=Math.abs(w)<.5;d.push({x:a,isAxis:h,isMajor:!1,isInteger:!0,value:w})}}const j=Math.floor(c.bottom/r)*r,F=Math.ceil(c.top/r)*r;for(let l=j;l<=F;l+=r){const p=i({x:0,y:l}).y,w=Math.abs(l)<r/2,a=Math.abs(l%(r*5))<r/2;x.push({y:p,isAxis:w,isMajor:a,isInteger:!1,value:l})}if(r>=2&&o){const l=Math.floor(c.bottom),p=Math.ceil(c.top);for(let w=l;w<=p;w+=1)if(Math.abs(w%r)>.001){const a=i({x:0,y:w}).y,h=Math.abs(w)<.5;x.push({y:a,isAxis:h,isMajor:!1,isInteger:!0,value:w})}}return{verticalLines:d,horizontalLines:x}}function R(t,e){return e>=1?t.toFixed(0):e>=.1?t.toFixed(1):e>=.01?t.toFixed(2):t.toFixed(3)}function ge(t,e,s){if(s!=="adaptive")switch(s){case"whole":return 1;case"half":return .5;case"quarter":return .25;case"tenth":return .1;default:return 1}const o=Ce(t,{minSpacing:8,maxSpacing:80,labelMinSpacing:40}).gridSize/e;return o<=.1?o:o<=.5?.1:o<=2?.25:1}const Oe={showEquivalentFractions:!0,showLengthMultiples:!0,showAreaRectangle:!0,showRiseRunTriangle:!1,showDistanceMarkers:!1,showAngleArc:!1,showDivisionAnswer:!0,showLatticePoints:!1,showIntegerGridLines:!0,showReferenceLineY_equals_X:!0,fontScale:1,gridScale:1,snapPrecision:"whole",coordinateSystem:"cartesian",showPolarGrid:!1,customOrigin:null},xe=fe(t=>({...Oe,toggleSetting:e=>{t(s=>({[e]:!s[e]}))},setFontScale:e=>{t({fontScale:e})},setGridScale:e=>{t({gridScale:e})},setSnapPrecision:e=>{t({snapPrecision:e})},setCoordinateSystem:e=>{t({coordinateSystem:e})},setCustomOrigin:e=>{t({customOrigin:e})},resetToDefaults:()=>{t(Oe)}}));function Je({viewport:t,canvasSize:e,worldToScreen:s,objects:i=[]}){const o=xe(),r=a=>Math.round(a*o.fontScale),c=Ce(t,{minSpacing:8,maxSpacing:80,labelMinSpacing:40}),d={gridSize:c.gridSize/o.gridScale,labelStep:c.labelStep/o.gridScale},{verticalLines:x,horizontalLines:f}=Ke(t,e,d,s,o.showIntegerGridLines);if(!c.shouldShowGrid)return null;const M=[];if(o.coordinateSystem==="polar"||o.coordinateSystem==="both"){const a=s({x:0,y:0}),h=Math.max(Math.abs(t.center.x)+e.width/(2*t.zoom),Math.abs(t.center.y)+e.height/(2*t.zoom));for(let g=d.gridSize;g<=h;g+=d.gridSize){const b=g*t.zoom;b>=10&&M.push(n.jsx("circle",{cx:a.x,cy:a.y,r:b,fill:"none",stroke:"#9CA3AF",strokeWidth:"0.5",opacity:.4},`polar-circle-${g}`))}for(let g=0;g<360;g+=30){const b=g*Math.PI/180,v=a.x+h*t.zoom*Math.cos(b),P=a.y-h*t.zoom*Math.sin(b);M.push(n.jsx("line",{x1:a.x,y1:a.y,x2:v,y2:P,stroke:"#9CA3AF",strokeWidth:"0.5",opacity:.3},`polar-line-${g}`))}}const j=[];i.forEach(a=>{if(a.type==="ray"){const{startPoint:h,endPoint:g}=a.properties;if(Math.abs(h.x)<.001&&Math.abs(h.y)<.001){const b=g.x-h.x,v=g.y-h.y;if(Math.abs(b)>.001){const P=1/b;if(P>0&&P<=1){const N=h.y+P*v,E=s({x:1,y:N});j.push({y:N,screenY:E.y})}}}}});const F=x.map(a=>{const h=Math.abs(a.value-1)<.001,g=a.isAxis?"#374151":h?"#60A5FA":a.isInteger?"#E5E7EB":a.isMajor?"#9CA3AF":"#E5E7EB",b=a.isAxis?2:h?1.5:a.isInteger?Math.max(1,t.zoom*.05):a.isMajor?1:.5,v=a.isAxis?1:h?.8:a.isInteger?Math.max(.6,.4*c.opacity):a.isMajor?.6*c.opacity:.3*c.opacity;return n.jsx("line",{x1:a.x,y1:0,x2:a.x,y2:e.height,stroke:g,strokeWidth:b,opacity:v},`v${a.value}`)}),l=f.map(a=>n.jsx("line",{x1:0,y1:a.y,x2:e.width,y2:a.y,stroke:a.isAxis?"#374151":a.isInteger?"#E5E7EB":a.isMajor?"#9CA3AF":"#E5E7EB",strokeWidth:a.isAxis?2:a.isInteger?Math.max(1,t.zoom*.05):a.isMajor?1:.5,opacity:a.isAxis?1:a.isInteger?Math.max(.6,.4*c.opacity):a.isMajor?.6*c.opacity:.3*c.opacity},`h${a.value}`)),p=o.showReferenceLineY_equals_X?(()=>{const a={left:t.center.x-e.width/2/t.zoom,right:t.center.x+e.width/2/t.zoom,top:t.center.y+e.height/2/t.zoom,bottom:t.center.y-e.height/2/t.zoom},h=Math.min(a.left,a.bottom),g=Math.max(a.right,a.top),b=s({x:h,y:h}),v=s({x:g,y:g});return{lineStart:b,lineEnd:v}})():null,w=o.showLatticePoints?(()=>{const a={left:t.center.x-e.width/2/t.zoom,right:t.center.x+e.width/2/t.zoom,top:t.center.y+e.height/2/t.zoom,bottom:t.center.y-e.height/2/t.zoom},h=[],g=Math.max(-20,Math.floor(a.left)),b=Math.min(20,Math.ceil(a.right)),v=Math.max(-20,Math.floor(a.bottom)),P=Math.min(20,Math.ceil(a.top)),N=(b-g+1)*(P-v+1);if(N>200){const E=Math.ceil(Math.sqrt(N/200));for(let _=g;_<=b;_+=E)for(let C=v;C<=P;C+=E){const k=s({x:_,y:C});k.x>=-20&&k.x<=e.width+20&&k.y>=-20&&k.y<=e.height+20&&h.push(k)}}else for(let E=g;E<=b;E++)for(let _=v;_<=P;_++){const C=s({x:E,y:_});C.x>=-20&&C.x<=e.width+20&&C.y>=-20&&C.y<=e.height+20&&h.push(C)}return h})():[];return n.jsxs("g",{className:"grid",children:[(o.coordinateSystem==="polar"||o.coordinateSystem==="both")&&n.jsx("g",{className:"polar-grid",children:M}),(o.coordinateSystem==="cartesian"||o.coordinateSystem==="both")&&n.jsxs("g",{className:"cartesian-grid",children:[F,l]}),w.map((a,h)=>n.jsx("circle",{cx:a.x,cy:a.y,r:"1.5",fill:"#9CA3AF",opacity:"0.3"},`lattice-${h}`)),p&&n.jsx("line",{x1:p.lineStart.x,y1:p.lineStart.y,x2:p.lineEnd.x,y2:p.lineEnd.y,stroke:"#A78BFA",strokeWidth:"1.5",opacity:"0.6",strokeDasharray:"5,5"}),c.shouldShowLabels&&n.jsxs("g",{className:"labels",fontSize:"12",fill:"#374151",children:[x.filter(a=>{const h=Math.abs(a.value%d.labelStep)<d.gridSize/10,g=Math.abs(a.value)>=d.labelStep/2;return h&&g}).filter((a,h,g)=>!g.slice(0,h).some(b=>Math.abs(b.value-a.value)<.001)).map(a=>n.jsx("text",{x:a.x,y:s({x:0,y:0}).y+20,textAnchor:"middle",fontSize:r(11),fontWeight:"500",opacity:Math.max(.7,c.opacity),children:R(a.value,c.gridSize)},`xlabel${a.value}`)),f.filter(a=>{const h=Math.abs(a.value%d.labelStep)<d.gridSize/10,g=Math.abs(a.value)>=d.labelStep/2;return h&&g}).filter((a,h,g)=>!g.slice(0,h).some(b=>Math.abs(b.value-a.value)<.001)).map(a=>n.jsx("text",{x:s({x:0,y:0}).x-15,y:a.y+4,textAnchor:"middle",fontSize:r(11),fontWeight:"500",opacity:Math.max(.7,c.opacity),children:R(a.value,c.gridSize)},`ylabel${a.value}`)),n.jsxs("g",{children:[n.jsx("circle",{cx:s({x:0,y:0}).x,cy:s({x:0,y:0}).y,r:"3",fill:"#374151",opacity:"0.6"}),n.jsx("text",{x:s({x:0,y:0}).x-25,y:s({x:0,y:0}).y-10,fontSize:r(11),fontWeight:"600",fill:"#374151",opacity:Math.max(.8,c.opacity),children:"(0,0)"})]}),o.showDivisionAnswer&&j.map((a,h)=>{const g=s({x:1,y:0}).x;return n.jsxs("g",{children:[n.jsx("circle",{cx:g,cy:a.screenY,r:"4",fill:"white",stroke:"#60A5FA",strokeWidth:"2",opacity:"0.9"}),n.jsxs("text",{x:g+15,y:a.screenY+4,fontSize:r(10),fontWeight:"600",fill:"#60A5FA",opacity:"0.9",children:["y = ",a.y.toFixed(2)]})]},`ray-intersection-${h}`)})]})]})}function Qe({viewport:t,onZoomIn:e,onZoomOut:s,onZoomReset:i,onCenterOnly:o}){const[r,c]=y.useState(0),d=y.useRef(null),x=()=>{const f=Date.now();f-r<500?(d.current&&(clearTimeout(d.current),d.current=null),i()):d.current=window.setTimeout(()=>{o(),d.current=null},300),c(f)};return n.jsxs("div",{className:"absolute bottom-4 right-4 flex flex-col gap-2",children:[n.jsx("button",{onClick:e,className:"w-10 h-10 bg-white/90 hover:bg-white border border-gray-300 rounded-lg shadow-md flex items-center justify-center text-gray-700 font-bold transition-colors",title:"Zoom in (Ctrl+scroll up)",disabled:t.zoom>=1e3,children:"+"}),n.jsx("button",{onClick:s,className:"w-10 h-10 bg-white/90 hover:bg-white border border-gray-300 rounded-lg shadow-md flex items-center justify-center text-gray-700 font-bold transition-colors",title:"Zoom out (Ctrl+scroll down)",disabled:t.zoom<=.01,children:"−"}),n.jsx("button",{onClick:x,className:"w-10 h-10 bg-white/90 hover:bg-white border border-gray-300 rounded-lg shadow-md flex items-center justify-center text-gray-600 text-xs transition-colors",title:"Center view (single click) or Reset zoom (double click)",children:"⌂"}),n.jsxs("div",{className:"w-10 h-6 bg-white/90 border border-gray-300 rounded text-xs flex items-center justify-center text-gray-600",children:[t.zoom>=1?Math.round(t.zoom):t.zoom.toFixed(1),"×"]})]})}function Ve({objects:t,viewport:e,touchTargetSize:s,worldToScreen:i,selectedObjects:o=[],canvasSize:r}){const c=xe(),d=l=>Math.round(l*c.fontScale),x=ge(e,c.gridScale,c.snapPrecision),f=x,[M,j]=y.useState(null),F=l=>{const p=o.includes(l.id);switch(l.type){case"ray":const w=i(l.properties.startPoint),a=i(l.properties.endPoint);return n.jsxs("g",{children:[p&&n.jsx("line",{x1:w.x,y1:w.y,x2:a.x,y2:a.y,stroke:"#60A5FA",strokeWidth:6,opacity:.4}),n.jsx("line",{x1:w.x,y1:w.y,x2:a.x,y2:a.y,stroke:p?"#1D4ED8":"#2563eb",strokeWidth:p?3:2}),n.jsx("circle",{cx:w.x,cy:w.y,r:s/4,fill:p?"#1D4ED8":"#2563eb",stroke:p?"#60A5FA":"none",strokeWidth:p?2:0,style:{cursor:"move"},onMouseEnter:()=>j(`${l.id}-start`),onMouseLeave:()=>j(null)}),n.jsx("circle",{cx:a.x,cy:a.y,r:s/4,fill:p?"#1D4ED8":"#2563eb",stroke:p?"#60A5FA":"none",strokeWidth:p?2:0,style:{cursor:"move"},onMouseEnter:()=>j(`${l.id}-end`),onMouseLeave:()=>j(null)}),!(Math.abs(l.properties.startPoint.x)<.001&&Math.abs(l.properties.startPoint.y)<.001)&&M===`${l.id}-start`&&n.jsxs("text",{x:w.x-5,y:w.y-10,fontSize:d(10),fontWeight:"500",fill:p?"#1D4ED8":"#2563eb",textAnchor:"middle",opacity:"0.8",children:["(",R(l.properties.startPoint.x,f),", ",R(l.properties.startPoint.y,f),")"]}),M===`${l.id}-end`&&n.jsxs("text",{x:Math.abs(l.properties.startPoint.x)<.001&&Math.abs(l.properties.startPoint.y)<.001?a.x-60:a.x+5,y:Math.abs(l.properties.startPoint.x)<.001&&Math.abs(l.properties.startPoint.y)<.001?a.y+4:a.y-10,fontSize:d(10),fontWeight:"500",fill:p?"#1D4ED8":"#2563eb",textAnchor:Math.abs(l.properties.startPoint.x)<.001&&Math.abs(l.properties.startPoint.y)<.001?"end":"middle",opacity:"0.8",children:["(",R(l.properties.endPoint.x,f),", ",R(l.properties.endPoint.y,f),")"]}),(()=>{const _=l.properties.endPoint.x-l.properties.startPoint.x;l.properties.endPoint.y-l.properties.startPoint.y;const C=Math.abs(l.properties.startPoint.x)<.001&&Math.abs(l.properties.startPoint.y)<.001;if(Math.abs(_)>.001){const k=a.x,q=a.y;if(C){const U=l.properties.endPoint.x,H=l.properties.endPoint.y,T=R(H,f),Z=R(U,f);return n.jsxs("g",{children:[n.jsx("text",{x:k+15,y:q-25,fontSize:d(9),fontWeight:"500",fill:p?"#1D4ED8":"#2563eb",textAnchor:"middle",opacity:"0.8",children:T}),n.jsx("line",{x1:k+8,y1:q-19,x2:k+22,y2:q-19,stroke:p?"#1D4ED8":"#2563eb",strokeWidth:"1",opacity:"0.8"}),n.jsx("text",{x:k+15,y:q-9,fontSize:d(9),fontWeight:"500",fill:p?"#1D4ED8":"#2563eb",textAnchor:"middle",opacity:"0.8",children:Z})]})}else return null}return null})(),(()=>{if(!(Math.abs(l.properties.startPoint.x)<.001&&Math.abs(l.properties.startPoint.y)<.001))return null;const C=l.properties.endPoint.x,k=l.properties.endPoint.y;if(Math.abs(C)<.001&&Math.abs(k)<.001)return null;const q=C,U=k,H={left:e.center.x-r.width/2/e.zoom,right:e.center.x+r.width/2/e.zoom,top:e.center.y+r.height/2/e.zoom,bottom:e.center.y-r.height/2/e.zoom},T=Math.max(Math.abs(H.left),Math.abs(H.right),Math.abs(H.top),Math.abs(H.bottom))*2,Z=Math.sqrt(q*q+U*U);if(Z===0)return null;const ne=q/Z,le=U/Z,re={x:T*ne,y:T*le},ie=i(re),u=[];if(Math.abs(C)>.001&&Math.abs(k)>.001){const m=k/C;for(let S=x;S<=Math.min(20,Math.abs(T));S+=x){const D=m*S,W=Math.round(S/x)*x,B=Math.round(D/x)*x;if(Math.abs(S-W)<x/10&&Math.abs(D-B)<x/10&&Math.abs(W)<=T&&Math.abs(B)<=T&&W>0&&B>0){const $=i({x:W,y:B});$.x>=-100&&$.x<=r.width+100&&$.y>=-100&&$.y<=r.height+100&&u.push({world:{x:W,y:B},screen:$,fraction:{num:R(B,x),den:R(W,x)}})}}}const A=Math.sqrt(C*C+k*k),Y=[];if(A>0&&c.showLengthMultiples)for(let m=2;m<=5;m++){const S=C*m,D=k*m,W=i({x:S,y:D});W.x>=-50&&W.x<=r.width+50&&W.y>=-50&&W.y<=r.height+50&&Y.push({screen:W,multiple:m})}return n.jsxs("g",{children:[c.showEquivalentFractions&&n.jsx("line",{x1:a.x,y1:a.y,x2:ie.x,y2:ie.y,stroke:p?"#1D4ED8":"#2563eb",strokeWidth:"1",opacity:"0.3",strokeDasharray:"3,3"}),Y.map((m,S)=>n.jsxs("g",{children:[n.jsx("circle",{cx:m.screen.x,cy:m.screen.y,r:"2",fill:p?"#1D4ED8":"#2563eb",opacity:"0.4"}),n.jsxs("text",{x:m.screen.x+8,y:m.screen.y-8,fontSize:d(7),fontWeight:"400",fill:p?"#1D4ED8":"#2563eb",textAnchor:"start",opacity:"0.5",children:["×",m.multiple]})]},`length-${S}`)),c.showAreaRectangle&&(()=>{if(C>0&&k>0){const m=i({x:0,y:0}),S=i({x:C,y:k}),D=Math.abs(S.x-m.x),W=Math.abs(S.y-m.y),B=Math.min(m.x,S.x),$=Math.min(m.y,S.y),K=C*k;return n.jsxs("g",{children:[n.jsx("rect",{x:B,y:$,width:D,height:W,fill:p?"#1D4ED8":"#2563eb",opacity:"0.08",stroke:p?"#1D4ED8":"#2563eb",strokeWidth:"0.5",strokeOpacity:"0.15"}),n.jsxs("text",{x:B+D/2,y:$+15,fontSize:d(10),fontWeight:"400",fill:p?"#1D4ED8":"#2563eb",textAnchor:"middle",opacity:"0.6",children:[R(k,f)," × ",R(C,f)," = ",R(K,f)]})]})}return null})(),c.showRiseRunTriangle&&(()=>{if(C>0&&k>0){const m=i({x:0,y:0}),S=i({x:C,y:0}),D=i({x:C,y:k});return n.jsxs("g",{children:[n.jsx("path",{d:`M ${m.x},${m.y} L ${S.x},${S.y} L ${D.x},${D.y} Z`,fill:"none",stroke:p?"#1D4ED8":"#2563eb",strokeWidth:"1",opacity:"0.4",strokeDasharray:"2,2"}),n.jsxs("text",{x:S.x+10,y:(S.y+D.y)/2,fontSize:d(9),fontWeight:"500",fill:p?"#1D4ED8":"#2563eb",textAnchor:"start",opacity:"0.7",children:["rise: ",R(k,f)]}),n.jsxs("text",{x:(m.x+S.x)/2,y:S.y+8,fontSize:d(9),fontWeight:"500",fill:p?"#1D4ED8":"#2563eb",textAnchor:"middle",opacity:"0.7",children:["run: ",R(C,f)]})]})}return null})(),c.showDistanceMarkers&&(()=>{const m=[],S=Math.sqrt(C*C+k*k);if(S>0){const D=i({x:0,y:0});let W=Math.atan2(k,C);W<0&&(W=W+2*Math.PI);const B=[];for(let K=1;K<=Math.floor(S);K++)B.push({radius:K,isUnit:!0});B.push({radius:S,isUnit:!1}),B.forEach(({radius:K,isUnit:ee},O)=>{const I=K*e.zoom;if(I>=15&&I<=800&&Math.abs(W)>.05){const L=W>Math.PI?1:0,z=`M ${D.x+I},${D.y} A ${I},${I} 0 ${L},0 ${D.x+I*Math.cos(W)},${D.y-I*Math.sin(W)}`;m.push(n.jsx("path",{d:z,fill:"none",stroke:p?"#1D4ED8":"#2563eb",strokeWidth:ee?"1":"1.5",opacity:ee?"0.3":"0.6",strokeDasharray:ee?"2,2":"none"},`radial-${l.id}-${K.toFixed(3)}-${W.toFixed(3)}-${O}`))}});const $=i({x:S,y:0});m.push(n.jsxs("g",{children:[n.jsx("path",{d:`M ${$.x},${D.y} L ${$.x-4},${D.y+8} L ${$.x+4},${D.y+8} Z`,fill:p?"#1D4ED8":"#2563eb",opacity:"0.7"}),n.jsxs("text",{x:$.x-15,y:D.y-8,fontSize:d(8),fontWeight:"600",fill:p?"#1D4ED8":"#2563eb",textAnchor:"end",opacity:"0.8",children:["d = ",S.toFixed(2)]})]},`distance-${l.id}`))}return n.jsx("g",{children:m})})(),c.showAngleArc&&(()=>{let m=Math.atan2(k,C);if(m<0&&(m=m+2*Math.PI),Math.abs(C)>.05||Math.abs(k)>.05){const S=i({x:0,y:0}),D=50,W=(m*180/Math.PI).toFixed(1),B=m,$=m>Math.PI?1:0,K=`M ${S.x+D},${S.y} A ${D},${D} 0 ${$},0 ${S.x+D*Math.cos(B)},${S.y-D*Math.sin(B)}`,ee=m/2,O=D*.7,I=S.x+O*Math.cos(ee),L=S.y-O*Math.sin(ee);return n.jsxs("g",{children:[n.jsx("path",{d:K,fill:"none",stroke:p?"#1D4ED8":"#2563eb",strokeWidth:"2",opacity:"0.6"}),n.jsxs("text",{x:I,y:L,fontSize:d(11),fontWeight:"600",fill:p?"#1D4ED8":"#2563eb",textAnchor:"middle",opacity:"0.8",children:["θ = ",W,"°"]})]})}return null})(),c.showEquivalentFractions&&u.map((m,S)=>{const W=Math.abs(m.world.x-1)<.1&&c.showDivisionAnswer,B=Math.abs(m.world.x-C)<.1&&Math.abs(m.world.y-k)<.1;return W||B?null:n.jsxs("g",{children:[n.jsx("circle",{cx:m.screen.x,cy:m.screen.y,r:"4",fill:"white",stroke:"#22C55E",strokeWidth:"2",opacity:"0.8"}),n.jsxs("text",{x:m.screen.x+15,y:m.screen.y+4,fontSize:d(9),fontWeight:"500",fill:"#22C55E",textAnchor:"start",opacity:"0.8",children:[m.fraction.num,"/",m.fraction.den]})]},`equiv-${S}`)})]})})()]},l.id);case"rectangle":const h=i({x:l.properties.x,y:l.properties.y+l.properties.height}),g=l.properties.width*e.zoom,b=l.properties.height*e.zoom,v={x:l.properties.x,y:l.properties.y},P={x:l.properties.x+l.properties.width,y:l.properties.y},N={x:l.properties.x,y:l.properties.y+l.properties.height},E={x:l.properties.x+l.properties.width,y:l.properties.y+l.properties.height};return n.jsxs("g",{children:[p&&n.jsx("rect",{x:h.x-3,y:h.y-3,width:g+6,height:b+6,fill:"none",stroke:"#60A5FA",strokeWidth:4,opacity:.5,style:{cursor:"pointer"}}),n.jsx("rect",{x:h.x,y:h.y,width:g,height:b,fill:p?"rgba(34, 197, 94, 0.3)":"rgba(34, 197, 94, 0.2)",stroke:p?"#16A34A":"#22c55e",strokeWidth:p?3:2,style:{cursor:"pointer"}}),n.jsx("circle",{cx:h.x,cy:h.y,r:s/6,fill:p?"#16A34A":"#22c55e",stroke:p?"#60A5FA":"none",strokeWidth:p?2:0,style:{cursor:"nw-resize"}}),n.jsx("circle",{cx:h.x+g,cy:h.y,r:s/6,fill:p?"#16A34A":"#22c55e",stroke:p?"#60A5FA":"none",strokeWidth:p?2:0,style:{cursor:"ne-resize"}}),n.jsx("circle",{cx:h.x,cy:h.y+b,r:s/6,fill:p?"#16A34A":"#22c55e",stroke:p?"#60A5FA":"none",strokeWidth:p?2:0,style:{cursor:"sw-resize"}}),n.jsx("circle",{cx:h.x+g,cy:h.y+b,r:s/6,fill:p?"#16A34A":"#22c55e",stroke:p?"#60A5FA":"none",strokeWidth:p?2:0,style:{cursor:"se-resize"}}),n.jsxs("text",{x:h.x-10,y:h.y-5,fontSize:d(9),fontWeight:"500",fill:"#22c55e",textAnchor:"end",opacity:"0.8",children:["(",R(N.x,f),", ",R(N.y,f),")"]}),n.jsxs("text",{x:h.x+g+10,y:h.y-5,fontSize:d(9),fontWeight:"500",fill:"#22c55e",textAnchor:"start",opacity:"0.8",children:["(",R(E.x,f),", ",R(E.y,f),")"]}),n.jsxs("text",{x:h.x-10,y:h.y+b+15,fontSize:d(9),fontWeight:"500",fill:"#22c55e",textAnchor:"end",opacity:"0.8",children:["(",R(v.x,f),", ",R(v.y,f),")"]}),n.jsxs("text",{x:h.x+g+10,y:h.y+b+15,fontSize:d(9),fontWeight:"500",fill:"#22c55e",textAnchor:"start",opacity:"0.8",children:["(",R(P.x,f),", ",R(P.y,f),")"]}),n.jsxs("text",{x:h.x+g/2,y:h.y+b/2,fontSize:d(12),fontWeight:"600",fill:"#22c55e",textAnchor:"middle",opacity:"0.9",children:[R(l.properties.height,f)," × ",R(l.properties.width,f)," = ",R(l.properties.area,f)]})]},l.id);default:return null}};return n.jsxs(n.Fragment,{children:[n.jsx("defs",{}),n.jsx("g",{className:"objects",children:t.map(F)})]})}function et({capabilities:t,viewport:e,activeTool:s,selectedObjectsCount:i}){return t?n.jsxs("div",{className:"absolute top-2 left-2 text-xs text-gray-500 bg-white/80 p-2 rounded shadow-sm",children:[n.jsxs("div",{children:["Input: ",t.hasTouch?"👆":"🖱️"," ",t.hasPencil?"✏️":""]}),n.jsxs("div",{children:["Zoom: ",e.zoom>=1?e.zoom.toFixed(1):e.zoom.toFixed(2),"×"]}),n.jsxs("div",{children:["Center: (",e.center.x.toFixed(1),", ",e.center.y.toFixed(1),")"]}),n.jsxs("div",{children:["Tool: ",s||"Pan Mode"]}),i>0&&n.jsxs("div",{children:["Selected: ",i," object",i!==1?"s":""]})]}):null}function tt({selectedObject:t,onDelete:e,onClose:s}){if(!t)return null;const i=()=>{e(),s()},o=()=>{switch(t.type){case"ray":const{startPoint:r,endPoint:c,slope:d}=t.properties,x=Math.abs(r.x)<.001&&Math.abs(r.y)<.001;return n.jsxs("div",{className:"space-y-2",children:[n.jsx("div",{className:"text-sm font-medium text-gray-700",children:"Line Details"}),n.jsxs("div",{className:"space-y-1 text-xs text-gray-600",children:[n.jsxs("div",{children:["Start: (",R(r.x,1),", ",R(r.y,1),")"]}),n.jsxs("div",{children:["End: (",R(c.x,1),", ",R(c.y,1),")"]}),x&&n.jsxs("div",{children:["Fraction: ",Math.round(c.y),"/",Math.round(c.x)]}),n.jsxs("div",{children:["Slope: ",isFinite(d)?d.toFixed(3):"undefined"]})]})]});case"rectangle":const{x:f,y:M,width:j,height:F,area:l}=t.properties;return n.jsxs("div",{className:"space-y-2",children:[n.jsx("div",{className:"text-sm font-medium text-gray-700",children:"Rectangle Details"}),n.jsxs("div",{className:"space-y-1 text-xs text-gray-600",children:[n.jsxs("div",{children:["Position: (",R(f,1),", ",R(M,1),")"]}),n.jsxs("div",{children:["Size: ",R(j,1)," × ",R(F,1)]})]})]});default:return null}};return n.jsxs("div",{className:"fixed top-4 right-4 bg-white border border-gray-200 rounded-lg shadow-lg p-3 z-50 min-w-48",children:[o(),n.jsxs("div",{className:"mt-3 pt-2 border-t border-gray-100 flex gap-2",children:[n.jsxs("button",{onClick:i,className:"flex items-center gap-1 px-2 py-1 text-xs text-red-600 hover:bg-red-50 rounded transition-colors",children:[n.jsx("span",{children:"🗑️"}),"Delete"]}),n.jsxs("button",{onClick:s,className:"flex items-center gap-1 px-2 py-1 text-xs text-gray-600 hover:bg-gray-50 rounded transition-colors",children:[n.jsx("span",{children:"✕"}),"Close"]})]})]})}function st(){const[t,e]=y.useState(!1),s=y.useRef(null),i=xe(),{toggleSetting:o,setFontScale:r,setGridScale:c,setSnapPrecision:d,setCoordinateSystem:x,resetToDefaults:f}=i;y.useEffect(()=>{function j(F){s.current&&!s.current.contains(F.target)&&e(!1)}if(t)return document.addEventListener("mousedown",j,!0),document.addEventListener("click",j,!0),()=>{document.removeEventListener("mousedown",j,!0),document.removeEventListener("click",j,!0)}},[t]);const M=[{title:"Origin Lines",subtitle:"Enhancements for lines from (0,0)",settings:[{key:"showEquivalentFractions",label:"Equivalent Fractions",description:"Green circles showing equivalent fractions"},{key:"showLengthMultiples",label:"Length Multiples",description:"Small dots at 2×, 3×, 4× line length"},{key:"showAreaRectangle",label:"Area Rectangle",description:"Soft rectangle showing multiplication"},{key:"showRiseRunTriangle",label:"Rise/Run Triangle",description:"Triangle showing slope components"},{key:"showDistanceMarkers",label:"Distance Markers",description:"Radial quarter-circles at unit distances"},{key:"showAngleArc",label:"Angle Arc",description:"Arc showing angle from x-axis with measurement"}]},{title:"Division & Fractions",subtitle:"Visual fraction and division concepts",settings:[{key:"showDivisionAnswer",label:"Division Answer (x=1 line)",description:"Blue dot showing y-value at x=1"}]},{title:"Grid & Reference",subtitle:"Grid enhancements and reference lines",settings:[{key:"showLatticePoints",label:"Lattice Points",description:"Dots at all integer coordinates"},{key:"showIntegerGridLines",label:"Integer Grid Lines",description:"Faint lines at whole numbers"},{key:"showReferenceLineY_equals_X",label:"y=x Reference Line",description:"Purple diagonal line for comparison"}]},{title:"Display",subtitle:"Adjust visibility for classrooms and large screens",settings:[]}];return n.jsxs("div",{ref:s,className:"fixed bottom-4 left-4 z-50",children:[n.jsxs("button",{onClick:()=>e(!t),className:"flex items-center gap-2 px-3 py-2 bg-white border border-gray-200 rounded-lg shadow-sm hover:bg-gray-50 transition-colors",title:"Visualization Settings",children:[n.jsx("span",{className:"text-lg",children:"⚙️"}),n.jsx("span",{className:"text-sm font-medium text-gray-700",children:"Settings"}),n.jsx("span",{className:`text-xs transition-transform ${t?"":"rotate-180"}`,children:"▼"})]}),t&&n.jsxs("div",{className:"absolute bottom-full left-0 mb-2 bg-white border border-gray-200 rounded-lg shadow-lg w-80 max-h-[28rem] overflow-y-auto",children:[n.jsx("div",{className:"sticky top-0 bg-white border-b border-gray-100 px-4 py-3 rounded-t-lg",children:n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsx("h3",{className:"text-sm font-semibold text-gray-800",children:"Visualization Settings"}),n.jsx("button",{onClick:f,className:"text-xs text-blue-600 hover:text-blue-800 font-medium",children:"Reset All"})]})}),n.jsx("div",{className:"p-4 space-y-5",children:M.map((j,F)=>n.jsxs("div",{children:[n.jsxs("div",{className:`${F>0?"border-t border-gray-100 pt-4":""} mb-3`,children:[n.jsx("h4",{className:"text-xs font-semibold text-gray-700 uppercase tracking-wide",children:j.title}),j.subtitle&&n.jsx("p",{className:"text-xs text-gray-500 mt-0.5",children:j.subtitle})]}),n.jsxs("div",{className:"space-y-2.5",children:[j.settings.map(l=>n.jsxs("label",{className:"flex items-start gap-3 cursor-pointer group",children:[n.jsx("input",{type:"checkbox",checked:i[l.key],onChange:()=>o(l.key),className:"mt-0.5 w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500 focus:ring-2"}),n.jsxs("div",{className:"flex-1 min-w-0",children:[n.jsx("div",{className:"text-sm font-medium text-gray-700 group-hover:text-gray-900",children:l.label}),n.jsx("div",{className:"text-xs text-gray-500 leading-relaxed",children:l.description})]})]},l.key)),j.title==="Display"&&n.jsxs("div",{className:"space-y-3",children:[n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsx("label",{className:"text-sm font-medium text-gray-700",children:"Font Size"}),n.jsxs("span",{className:"text-xs text-gray-500 font-mono",children:[Math.round(i.fontScale*100),"%"]})]}),n.jsxs("div",{className:"flex items-center gap-3",children:[n.jsx("span",{className:"text-xs text-gray-400",children:"A"}),n.jsx("input",{type:"range",min:"0.8",max:"2.0",step:"0.1",value:i.fontScale,onChange:l=>r(parseFloat(l.target.value)),className:"flex-1 h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer slider"}),n.jsx("span",{className:"text-sm text-gray-600",children:"A"})]}),n.jsx("div",{className:"text-xs text-gray-500 leading-relaxed",children:"Increase font size for better visibility on TVs and projectors"}),n.jsxs("div",{className:"space-y-3 pt-4 border-t border-gray-100",children:[n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsx("label",{className:"text-sm font-medium text-gray-700",children:"Grid Density"}),n.jsxs("span",{className:"text-xs text-gray-500 font-mono",children:[Math.round(i.gridScale*100),"%"]})]}),n.jsxs("div",{className:"flex items-center gap-3",children:[n.jsx("span",{className:"text-xs text-gray-400",children:"Sparse"}),n.jsx("input",{type:"range",min:"0.2",max:"5.0",step:"0.1",value:i.gridScale,onChange:l=>c(parseFloat(l.target.value)),className:"flex-1 h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer slider"}),n.jsx("span",{className:"text-xs text-gray-600",children:"Dense"})]}),n.jsx("div",{className:"text-xs text-gray-500 leading-relaxed",children:"Adjust grid line spacing for different zoom levels and detail needs"})]}),n.jsxs("div",{className:"space-y-3 pt-4 border-t border-gray-100",children:[n.jsx("label",{className:"text-sm font-medium text-gray-700",children:"Coordinate System"}),n.jsx("div",{className:"space-y-2",children:[{value:"cartesian",label:"Cartesian Only",desc:"Standard x-y grid"},{value:"polar",label:"Polar Only",desc:"Circular coordinate system"},{value:"both",label:"Both Systems",desc:"Overlay polar on Cartesian"}].map(l=>n.jsxs("label",{className:"flex items-start gap-3 cursor-pointer group",children:[n.jsx("input",{type:"radio",name:"coordinateSystem",value:l.value,checked:i.coordinateSystem===l.value,onChange:p=>x(p.target.value),className:"mt-0.5 w-4 h-4 text-blue-600 border-gray-300 focus:ring-blue-500"}),n.jsxs("div",{className:"flex-1 min-w-0",children:[n.jsx("div",{className:"text-sm font-medium text-gray-700 group-hover:text-gray-900",children:l.label}),n.jsx("div",{className:"text-xs text-gray-500",children:l.desc})]})]},l.value))})]}),n.jsxs("div",{className:"space-y-3 pt-4 border-t border-gray-100",children:[n.jsx("label",{className:"text-sm font-medium text-gray-700",children:"Snap Precision"}),n.jsx("div",{className:"space-y-2",children:[{value:"adaptive",label:"Adaptive",desc:"Automatically adjusts based on zoom level"},{value:"whole",label:"Whole Numbers",desc:"Snap to 1, 2, 3, etc."},{value:"half",label:"Half Units",desc:"Snap to 0.5, 1.0, 1.5, etc."},{value:"quarter",label:"Quarter Units",desc:"Snap to 0.25, 0.5, 0.75, etc."},{value:"tenth",label:"Tenth Units",desc:"Snap to 0.1, 0.2, 0.3, etc."}].map(l=>n.jsxs("label",{className:"flex items-start gap-3 cursor-pointer group",children:[n.jsx("input",{type:"radio",name:"snapPrecision",value:l.value,checked:i.snapPrecision===l.value,onChange:p=>d(p.target.value),className:"mt-0.5 w-4 h-4 text-blue-600 border-gray-300 focus:ring-blue-500"}),n.jsxs("div",{className:"flex-1 min-w-0",children:[n.jsx("div",{className:"text-sm font-medium text-gray-700 group-hover:text-gray-900",children:l.label}),n.jsx("div",{className:"text-xs text-gray-500",children:l.desc})]})]},l.value))}),n.jsx("div",{className:"text-xs text-gray-500 leading-relaxed",children:"Controls where objects can be placed when snap-to-grid is enabled"})]})]})]})]},j.title))}),n.jsx("div",{className:"sticky bottom-0 bg-gray-50 border-t border-gray-100 px-4 py-2 rounded-b-lg",children:n.jsx("p",{className:"text-xs text-gray-500 text-center",children:"Toggle features to explore different mathematical concepts"})})]})]})}const Ae=(t,e)=>{const s=e*Math.PI/180,i=Math.cos(s),o=Math.sin(s);return{x:t.x*i-t.y*o,y:t.x*o+t.y*i}},nt=(t,e)=>({x:t.x*e,y:t.y*e}),Te=(t,e)=>{switch(e){case"x":return{x:t.x,y:-t.y};case"y":return{x:-t.x,y:t.y};case"origin":return{x:-t.x,y:-t.y};default:return t}},rt=fe((t,e)=>({isTransforming:!1,activeTransform:null,selectedObject:null,rotateObject:(s,i,o)=>{if(!o){console.log(`No canvas API provided for rotation of ${s}`);return}const r=o.getObject(s);if(r){if(r.type==="ray"){if(Math.abs(r.properties.startPoint.x)<.001&&Math.abs(r.properties.startPoint.y)<.001){const d=Ae(r.properties.endPoint,i);o.updateObject(s,{properties:{...r.properties,endPoint:d}})}}else if(r.type==="rectangle"){const c=r.properties.x+r.properties.width/2,d=r.properties.y+r.properties.height/2,x={x:r.properties.x-c,y:r.properties.y-d},f=Ae(x,i);o.updateObject(s,{properties:{...r.properties,x:f.x+c,y:f.y+d}})}}},scaleObject:(s,i,o)=>{if(!o){console.log(`No canvas API provided for scaling of ${s}`);return}const r=o.getObject(s);if(r)if(r.type==="ray"){if(Math.abs(r.properties.startPoint.x)<.001&&Math.abs(r.properties.startPoint.y)<.001){const d=nt(r.properties.endPoint,i);o.updateObject(s,{properties:{...r.properties,endPoint:d}})}}else r.type==="rectangle"&&o.updateObject(s,{properties:{...r.properties,width:r.properties.width*i,height:r.properties.height*i,area:r.properties.width*i*r.properties.height*i}})},reflectObject:(s,i,o)=>{if(!o){console.log(`No canvas API provided for reflection of ${s}`);return}const r=o.getObject(s);if(r){if(r.type==="ray"){if(Math.abs(r.properties.startPoint.x)<.001&&Math.abs(r.properties.startPoint.y)<.001){const d=Te(r.properties.endPoint,i);o.updateObject(s,{properties:{...r.properties,endPoint:d}})}}else if(r.type==="rectangle"){const c=Te({x:r.properties.x,y:r.properties.y},i);o.updateObject(s,{properties:{...r.properties,x:c.x,y:c.y}})}}},rotate90:(s,i)=>{e().rotateObject(s,90,i)},rotate180:(s,i)=>{e().rotateObject(s,180,i)},rotate270:(s,i)=>{e().rotateObject(s,270,i)},setActiveTransform:s=>{t({activeTransform:s,isTransforming:s!==null})},setSelectedObject:s=>{t({selectedObject:s})},clearTransform:()=>{t({isTransforming:!1,activeTransform:null,selectedObject:null})}}));function it(t,e,s){const i=s.x-e.x,o=s.y-e.y,r=Math.sqrt(i*i+o*o);if(r===0)return Math.sqrt(Math.pow(t.x-e.x,2)+Math.pow(t.y-e.y,2));const c=Math.max(0,Math.min(1,((t.x-e.x)*i+(t.y-e.y)*o)/(r*r))),d={x:e.x+c*i,y:e.y+c*o};return Math.sqrt(Math.pow(t.x-d.x,2)+Math.pow(t.y-d.y,2))}function De({width:t=800,height:e=600,className:s="",onObjectInteraction:i}){const o=y.useRef(null),{viewport:r,setViewport:c,objects:d,selectedObjects:x,snapToGrid:f,gridDensity:M,canvasSize:j,setCanvasSize:F,removeObject:l,clearSelection:p,selectObject:w,screenToWorld:a,worldToScreen:h,getObject:g,updateObject:b}=V(),v=He(),{activeTool:P,setActiveTool:N,eventBus:E}=ue(),{rotate90:_,rotate180:C,rotate270:k,scaleObject:q,setSelectedObject:U}=rt();y.useEffect(()=>{F({width:t,height:e})},[t,e,F]);const H=y.useRef({isPanning:!1,startPoint:{x:0,y:0},startCenter:{x:0,y:0}}),T=y.useRef({isDown:!1,startPoint:{x:0,y:0},hasMoved:!1,dragThreshold:5,pendingSelection:null}),[Z,ne]=y.useState(null),[le,re]=y.useState(!1),ie=y.useCallback(O=>{const I={x:O.x,y:O.y};T.current={isDown:!0,startPoint:I,hasMoved:!1,dragThreshold:5,pendingSelection:null};const L=22;a(I);let G=!1;for(const z of d)if(z.type==="ray"){const J=h(z.properties.startPoint),te=h(z.properties.endPoint),oe=Math.sqrt(Math.pow(I.x-J.x,2)+Math.pow(I.y-J.y,2)),pe=Math.sqrt(Math.pow(I.x-te.x,2)+Math.pow(I.y-te.y,2));if(oe<=L||pe<=L){G=!0,T.current.pendingSelection={objectId:z.id,type:"ray"},w(z.id);break}if(it(I,J,te)<=8){G=!0,T.current.pendingSelection={objectId:z.id,type:"ray"},w(z.id);break}}else if(z.type==="rectangle"){const J=h({x:z.properties.x,y:z.properties.y+z.properties.height}),te=z.properties.width*r.zoom,oe=z.properties.height*r.zoom;if(I.x>=J.x&&I.x<=J.x+te&&I.y>=J.y&&I.y<=J.y+oe){G=!0,T.current.pendingSelection={objectId:z.id,type:"rectangle"},w(z.id);break}if([{x:J.x,y:J.y},{x:J.x+te,y:J.y},{x:J.x,y:J.y+oe},{x:J.x+te,y:J.y+oe}].some(me=>Math.sqrt(Math.pow(I.x-me.x,2)+Math.pow(I.y-me.y,2))<=L)){G=!0,T.current.pendingSelection={objectId:z.id,type:"rectangle"},w(z.id);break}}(!G&&!P||!G&&P)&&p(),(P||G)&&v.handlePointerDown(O),!G&&!P&&(O.type==="touch"||O.type==="mouse")&&(H.current={isPanning:!0,startPoint:{x:O.x,y:O.y},startCenter:{...r.center}})},[r.center,v,P,N,d,a,h,r.zoom]),u=y.useCallback(O=>{const I={x:O.x,y:O.y};if(O.type==="mouse"&&P?ne(I):P||ne(null),T.current.isDown&&!T.current.hasMoved){const L=Math.abs(O.x-T.current.startPoint.x),G=Math.abs(O.y-T.current.startPoint.y);Math.sqrt(L*L+G*G)>=T.current.dragThreshold&&(T.current.hasMoved=!0,T.current.pendingSelection=null)}if(v.handlePointerMove(O),!P&&H.current.isPanning){const L=(O.x-H.current.startPoint.x)/r.zoom,G=(O.y-H.current.startPoint.y)/r.zoom;c({center:{x:H.current.startCenter.x-L,y:H.current.startCenter.y+G}})}},[r.zoom,c,v,P,ne]),A=y.useCallback(O=>{T.current={isDown:!1,startPoint:{x:0,y:0},hasMoved:!1,dragThreshold:5,pendingSelection:null},v.handlePointerUp(O),H.current.isPanning=!1},[v,N]),Y=y.useCallback(O=>{switch(O.type){case"pinch":if(O.scale){const I=Math.max(.1,Math.min(10,r.zoom*O.scale));c({zoom:I})}break}},[r.zoom,c]),{capabilities:m,touchTargetSize:S}=Ee(o,{onPointerDown:ie,onPointerMove:u,onPointerUp:A,onGesture:Y},{enableGestures:!0,preventScrolling:!0});y.useEffect(()=>{const O=L=>{switch(L.key){case"Escape":P&&(E.emit("tool:cancel",{toolId:P}),N(null));break;case"Delete":case"Backspace":x.length>0&&(console.log("Deleting objects:",x),x.forEach(G=>{E.emit("object:removed",{objectId:G}),l(G)}),p(),N(null));break;case"r":case"R":if(x.length>0&&!L.ctrlKey){L.preventDefault();const G={getObject:g,updateObject:b};x.forEach(z=>{L.shiftKey?k(z,G):_(z,G)})}break;case"f":case"F":if(x.length>0&&!L.ctrlKey){L.preventDefault();const G={getObject:g,updateObject:b};x.forEach(z=>{C(z,G)})}break;case"=":case"+":if(x.length>0&&!L.ctrlKey){L.preventDefault();const G={getObject:g,updateObject:b};x.forEach(z=>{q(z,2,G)})}break;case"-":case"_":if(x.length>0&&!L.ctrlKey){L.preventDefault();const G={getObject:g,updateObject:b};x.forEach(z=>{q(z,.5,G)})}break}},I=L=>{console.log("Object created, returning to pan mode:",L),p(),N(null)};return document.addEventListener("keydown",O),E.on("tool:creation-complete",I),()=>{document.removeEventListener("keydown",O),E.off("tool:creation-complete",I)}},[P,N,E,x,l,p]),y.useEffect(()=>{x.length===1?re(!0):re(!1)},[x]);const D=y.useCallback(()=>{re(!1)},[]),W=y.useCallback(()=>{x.length>0&&(x.forEach(O=>{E.emit("object:removed",{objectId:O}),l(O)}),p())},[x,l,p,E]),B=y.useCallback(()=>{const O=Math.min(1e3,r.zoom*1.4);c({zoom:O})},[r.zoom,c]),$=y.useCallback(()=>{const O=Math.max(.01,r.zoom/1.4);c({zoom:O})},[r.zoom,c]),K=y.useCallback(()=>{c({zoom:20,center:{x:0,y:0}})},[c]),ee=y.useCallback(()=>{c({center:{x:0,y:0}})},[c]);return y.useEffect(()=>{const O=L=>{L.preventDefault();const z=V.getState().viewport;if(L.ctrlKey||L.metaKey){const J=L.deltaY>0?.9:1.1,te=Math.max(.01,Math.min(1e3,z.zoom*J));c({zoom:te})}else{const te=L.shiftKey?L.deltaY:0,oe=L.shiftKey?0:L.deltaY,pe=te*1/z.zoom,ye=oe*1/z.zoom;c({center:{x:z.center.x+pe,y:z.center.y-ye}})}},I=o.current;if(I)return I.addEventListener("wheel",O,{passive:!1}),()=>{I.removeEventListener("wheel",O)}},[c]),n.jsxs("div",{className:`relative ${s}`,style:{width:t,height:e},children:[n.jsxs("svg",{ref:o,width:t,height:e,className:"absolute inset-0 bg-white",style:{touchAction:"none"},children:[n.jsx(Je,{viewport:r,canvasSize:{width:t,height:e},worldToScreen:h,objects:d}),n.jsx(Ve,{objects:d,viewport:r,touchTargetSize:S,worldToScreen:h,selectedObjects:x,canvasSize:{width:t,height:e}}),P&&Z&&!T.current.isDown&&n.jsx("circle",{cx:Z.x,cy:Z.y,r:"4",fill:"rgba(37, 99, 235, 0.4)",stroke:"#2563eb",strokeWidth:"1",opacity:"0.8",style:{pointerEvents:"none"}})]}),n.jsx(et,{capabilities:m,viewport:r,activeTool:P,selectedObjectsCount:x.length}),n.jsx(Qe,{viewport:r,onZoomIn:B,onZoomOut:$,onZoomReset:K,onCenterOnly:ee}),le&&x.length===1&&n.jsx(tt,{selectedObject:d.find(O=>O.id===x[0])||null,onDelete:W,onClose:D}),n.jsx(st,{})]})}const Ne=[{id:"ray-tool",name:"Line Builder",icon:"📏",description:"Create and edit lines to explore slopes and fractions"},{id:"rectangle-tool",name:"Rectangle Builder",icon:"⬜",description:"Create rectangles to explore area and multiplication"}];function ze({className:t=""}){const{activeTool:e,setActiveTool:s}=ue(),[i,o]=y.useState(!1),r=y.useRef(null),c=M=>{s(M),o(!1)},d=()=>{s(null),o(!1)},x=()=>{o(!i)},f=Ne.find(M=>M.id===e);return y.useEffect(()=>{const M=j=>{r.current&&!r.current.contains(j.target)&&o(!1)};return i&&document.addEventListener("mousedown",M),()=>{document.removeEventListener("mousedown",M)}},[i]),n.jsxs("div",{className:`flex items-center gap-2 p-2 bg-white border-b border-gray-200 ${t}`,children:[n.jsxs("div",{className:"flex items-center gap-2 mr-4",children:[n.jsx("div",{className:"text-2xl",children:"🟦"}),n.jsx("h1",{className:"text-lg font-semibold text-gray-800",children:"Grix"})]}),n.jsxs("div",{className:"relative",ref:r,children:[n.jsxs("button",{onClick:x,className:`
            flex items-center gap-2 px-4 py-2 rounded-lg border transition-all
            ${e?"bg-blue-100 border-blue-300 text-blue-700":"bg-gray-50 border-gray-200 text-gray-700 hover:bg-gray-100"}
          `,children:[n.jsx("span",{className:"text-lg",children:"🏗️"}),n.jsx("span",{className:"text-sm font-medium",children:f?f.name:"Build"}),n.jsx("span",{className:`text-xs transition-transform ${i?"rotate-180":""}`,children:"▼"})]}),i&&n.jsxs("div",{className:"absolute top-full left-0 mt-1 bg-white border border-gray-200 rounded-lg shadow-lg z-50 min-w-48",children:[Ne.map(M=>n.jsxs("button",{onClick:()=>c(M.id),className:`
                  w-full flex items-center gap-3 px-4 py-3 text-left hover:bg-gray-50 first:rounded-t-lg last:rounded-b-lg transition-colors
                  ${e===M.id?"bg-blue-50 text-blue-700":"text-gray-700"}
                `,title:M.description,children:[n.jsx("span",{className:"text-lg",children:M.icon}),n.jsxs("div",{children:[n.jsx("div",{className:"text-sm font-medium",children:M.name}),n.jsx("div",{className:"text-xs text-gray-500",children:M.description})]})]},M.id)),e&&n.jsxs(n.Fragment,{children:[n.jsx("div",{className:"border-t border-gray-100"}),n.jsxs("button",{onClick:d,className:"w-full flex items-center gap-3 px-4 py-2 text-left hover:bg-gray-50 rounded-b-lg transition-colors text-gray-600",children:[n.jsx("span",{className:"text-lg",children:"✕"}),n.jsx("span",{className:"text-sm",children:"Clear selection"})]})]})]})]}),n.jsx("div",{className:"ml-auto flex items-center gap-4 text-sm text-gray-500",children:e?n.jsxs("span",{className:"flex items-center gap-1",children:[n.jsx("div",{className:"w-2 h-2 bg-green-400 rounded-full"}),(f==null?void 0:f.name)||"Active Tool"]}):n.jsxs("span",{className:"flex items-center gap-1",children:[n.jsx("div",{className:"w-2 h-2 bg-gray-300 rounded-full"}),"Click Build to start creating"]})})]})}class Re extends y.Component{constructor(e){super(e),this.state={hasError:!1}}static getDerivedStateFromError(e){return{hasError:!0,error:e}}componentDidCatch(e,s){console.error("Canvas Error Boundary caught an error:",e,s),this.setState({error:e,errorInfo:s})}render(){var e,s;if(this.state.hasError){const i=this.props.fallback;return i?n.jsx(i,{error:this.state.error}):n.jsx("div",{className:"flex items-center justify-center h-full bg-red-50 text-red-700 p-8",children:n.jsxs("div",{className:"text-center",children:[n.jsx("h2",{className:"text-xl font-semibold mb-4",children:"Something went wrong with the Canvas"}),n.jsxs("details",{className:"text-sm",children:[n.jsx("summary",{className:"cursor-pointer mb-2",children:"Error Details"}),n.jsxs("pre",{className:"whitespace-pre-wrap text-left bg-red-100 p-4 rounded",children:[(e=this.state.error)==null?void 0:e.toString(),(s=this.state.errorInfo)==null?void 0:s.componentStack]})]}),n.jsx("button",{onClick:()=>window.location.reload(),className:"mt-4 px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700",children:"Reload Page"})]})})}return this.props.children}}class ot{constructor(){Q(this,"id","ray-tool");Q(this,"name","Line Builder");Q(this,"context");Q(this,"state",{isCreating:!1,startPoint:null,currentRay:null,dragTarget:null,dragOffset:null})}init(e){this.context=e,e.events.on("tool:changed",this.handleToolChange.bind(this)),e.events.on("tool:cancel",this.handleToolCancel.bind(this))}destroy(){this.context.events.off("tool:changed",this.handleToolChange.bind(this)),this.context.events.off("tool:cancel",this.handleToolCancel.bind(this))}handleToolChange(e){e.current!==this.id&&this.cancelCreation()}handleToolCancel(e){e.toolId===this.id&&this.cancelCreation()}cancelCreation(){this.state.currentRay&&this.state.isCreating&&this.context.canvas.removeObject(this.state.currentRay.id),this.state={isCreating:!1,startPoint:null,currentRay:null,dragTarget:null,dragOffset:null}}generateId(){return`ray_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}snapPoint(e){const s=this.context.state.getState();if(s.snapToGrid){if(Math.sqrt(e.x*e.x+e.y*e.y)<=.75)return{x:0,y:0};const r=xe.getState(),c=ge(s.viewport,r.gridScale,r.snapPrecision);return this.context.math.snapToGrid(e,c)}return e}findNearestHandle(e,s=20){this.context.canvas.screenToWorld(e);const i=this.context.canvas.getAllObjects();for(const o of i)if(o.type==="ray"){const r=o,c=this.context.canvas.worldToScreen(r.properties.startPoint),d=this.context.canvas.worldToScreen(r.properties.endPoint),x=this.context.math.distance(e,c),f=this.context.math.distance(e,d);if(x<=s)return{rayId:r.id,handle:"start"};if(f<=s)return{rayId:r.id,handle:"end"};const M=8,j=d.x-c.x,F=d.y-c.y,l=Math.sqrt(j*j+F*F);if(l>0){const p=Math.max(0,Math.min(1,((e.x-c.x)*j+(e.y-c.y)*F)/(l*l))),w={x:c.x+p*j,y:c.y+p*F};if(this.context.math.distance(e,w)<=M)return{rayId:r.id,handle:"move"}}}return null}onPointerDown(e){const s={x:e.x,y:e.y},i=this.snapPoint(this.context.canvas.screenToWorld(s)),o=this.findNearestHandle(s);if(o){const r=this.context.canvas.getObject(o.rayId),c=this.context.state.getState().selectedObjects;if(r&&c.includes(o.rayId)){this.state.currentRay=r,this.state.dragTarget=o.handle,this.state.isCreating=!1,o.handle==="move"&&(this.state.dragOffset={x:i.x-r.properties.startPoint.x,y:i.y-r.properties.startPoint.y});return}}if(!this.state.isCreating){this.state.isCreating=!0,this.state.startPoint=i;const r={id:this.generateId(),type:"ray",properties:{startPoint:i,endPoint:{...i},slope:0,yIntercept:i.y},visible:!0,selected:!1};this.state.currentRay=r,this.context.canvas.addObject(r)}}onPointerMove(e){if(!this.state.currentRay)return;const s={x:e.x,y:e.y},i=this.snapPoint(this.context.canvas.screenToWorld(s));if(this.state.isCreating){const o=this.context.math.slope(this.state.currentRay.properties.startPoint,i),r=i.y-o*i.x;this.context.canvas.updateObject(this.state.currentRay.id,{properties:{...this.state.currentRay.properties,endPoint:i,slope:o,yIntercept:isFinite(o)?r:this.state.currentRay.properties.startPoint.y}})}else if(this.state.dragTarget){const o=this.context.canvas.getObject(this.state.currentRay.id);if(!o)return;const r={...o.properties};if(this.state.dragTarget==="start")r.startPoint=i;else if(this.state.dragTarget==="end")r.endPoint=i;else if(this.state.dragTarget==="move"&&this.state.dragOffset){const c=i.x-this.state.dragOffset.x-o.properties.startPoint.x,d=i.y-this.state.dragOffset.y-o.properties.startPoint.y;r.startPoint={x:o.properties.startPoint.x+c,y:o.properties.startPoint.y+d},r.endPoint={x:o.properties.endPoint.x+c,y:o.properties.endPoint.y+d}}if(this.state.dragTarget==="start"||this.state.dragTarget==="end"){const c=this.context.math.slope(r.startPoint,r.endPoint);r.slope=c,r.yIntercept=isFinite(c)?r.startPoint.y-c*r.startPoint.x:r.startPoint.y}this.context.canvas.updateObject(this.state.currentRay.id,{properties:r})}this.context.events.emit("ray:update",{rayId:this.state.currentRay.id,ray:this.context.canvas.getObject(this.state.currentRay.id)})}onPointerUp(e){if(this.state.isCreating&&this.state.currentRay){const s={x:e.x,y:e.y},i=this.snapPoint(this.context.canvas.screenToWorld(s)),o=this.state.currentRay.properties.startPoint;this.context.math.distance(o,i)<.1?this.context.canvas.removeObject(this.state.currentRay.id):(this.context.events.emit("ray:created",{rayId:this.state.currentRay.id,ray:this.state.currentRay}),this.context.events.emit("tool:creation-complete",{toolId:this.id,objectId:this.state.currentRay.id}))}this.state={isCreating:!1,startPoint:null,currentRay:null,dragTarget:null,dragOffset:null}}}function Fe(){return new ot}class at{constructor(){Q(this,"id","rectangle-tool");Q(this,"name","Rectangle Builder");Q(this,"context");Q(this,"state",{isCreating:!1,startPoint:null,currentRectangle:null,dragTarget:null,dragOffset:null,lockedCorner:null})}init(e){this.context=e,e.events.on("tool:changed",this.handleToolChange.bind(this)),e.events.on("tool:cancel",this.handleToolCancel.bind(this))}destroy(){this.context.events.off("tool:changed",this.handleToolChange.bind(this)),this.context.events.off("tool:cancel",this.handleToolCancel.bind(this))}handleToolChange(e){e.current!==this.id&&this.cancelCreation()}handleToolCancel(e){e.toolId===this.id&&this.cancelCreation()}cancelCreation(){this.state.currentRectangle&&this.state.isCreating&&this.context.canvas.removeObject(this.state.currentRectangle.id),this.state={isCreating:!1,startPoint:null,currentRectangle:null,dragTarget:null,dragOffset:null,lockedCorner:null}}generateId(){return`rect_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}snapPoint(e){const s=this.context.state.getState();if(s.snapToGrid){if(Math.sqrt(e.x*e.x+e.y*e.y)<=.75)return{x:0,y:0};const r=xe.getState(),c=ge(s.viewport,r.gridScale,r.snapPrecision);return this.context.math.snapToGrid(e,c)}return e}findRectangleAtPoint(e){const s=this.context.canvas.getAllObjects();for(const i of s)if(i.type==="rectangle"){const o=i,{x:r,y:c,width:d,height:x}=o.properties;if(e.x>=r&&e.x<=r+d&&e.y>=c&&e.y<=c+x)return o}return null}findNearestCorner(e,s,i=.5){const{x:o,y:r,width:c,height:d}=s.properties,x=[{point:{x:o,y:r},type:"corner-bl"},{point:{x:o+c,y:r},type:"corner-br"},{point:{x:o,y:r+d},type:"corner-tl"},{point:{x:o+c,y:r+d},type:"corner-tr"}];for(const f of x)if(this.context.math.distance(e,f.point)<=i)return f.type;return null}onPointerDown(e){const s={x:e.x,y:e.y},i=this.snapPoint(this.context.canvas.screenToWorld(s)),o=this.findRectangleAtPoint(i);if(o&&this.context.state.getState().selectedObjects.includes(o.id)){const d=this.findNearestCorner(i,o);if(d){this.state.currentRectangle=o,this.state.dragTarget=d,this.state.isCreating=!1;const{x,y:f,width:M,height:j}=o.properties;switch(d){case"corner-tl":this.state.lockedCorner={x:x+M,y:f};break;case"corner-tr":this.state.lockedCorner={x,y:f};break;case"corner-bl":this.state.lockedCorner={x:x+M,y:f+j};break;case"corner-br":this.state.lockedCorner={x,y:f+j};break}return}else{this.state.currentRectangle=o,this.state.dragTarget="move",this.state.dragOffset={x:i.x-o.properties.x,y:i.y-o.properties.y},this.state.isCreating=!1;return}}this.state.isCreating=!0,this.state.startPoint=i;const r={id:this.generateId(),type:"rectangle",properties:{x:i.x,y:i.y,width:0,height:0,area:0},visible:!0,selected:!1};this.state.currentRectangle=r,this.context.canvas.addObject(r)}onPointerMove(e){if(!this.state.currentRectangle)return;const s={x:e.x,y:e.y},i=this.snapPoint(this.context.canvas.screenToWorld(s));if(this.state.isCreating&&this.state.startPoint){const o=Math.min(this.state.startPoint.x,i.x),r=Math.min(this.state.startPoint.y,i.y),c=Math.abs(i.x-this.state.startPoint.x),d=Math.abs(i.y-this.state.startPoint.y),x=c*d;this.context.canvas.updateObject(this.state.currentRectangle.id,{properties:{x:o,y:r,width:c,height:d,area:x}})}else if(this.state.dragTarget==="move"&&this.state.dragOffset){const o=i.x-this.state.dragOffset.x,r=i.y-this.state.dragOffset.y;this.context.canvas.updateObject(this.state.currentRectangle.id,{properties:{...this.state.currentRectangle.properties,x:o,y:r}})}else if(this.state.dragTarget&&this.state.dragTarget.startsWith("corner-")&&this.state.lockedCorner){const o=this.state.lockedCorner,r=Math.min(i.x,o.x),c=Math.max(i.x,o.x),d=Math.min(i.y,o.y),x=Math.max(i.y,o.y),f=r,M=d,j=c-r,F=x-d,l=Math.max(.1,j),p=Math.max(.1,F),w=l*p;this.context.canvas.updateObject(this.state.currentRectangle.id,{properties:{x:f,y:M,width:l,height:p,area:w}})}this.context.events.emit("rectangle:update",{rectangleId:this.state.currentRectangle.id,rectangle:this.context.canvas.getObject(this.state.currentRectangle.id)})}onPointerUp(e){if(this.state.isCreating&&this.state.currentRectangle){const s=this.context.canvas.getObject(this.state.currentRectangle.id);s&&(s.properties.width<.1||s.properties.height<.1?this.context.canvas.removeObject(this.state.currentRectangle.id):(this.context.events.emit("rectangle:created",{rectangleId:this.state.currentRectangle.id,rectangle:s}),this.context.events.emit("tool:creation-complete",{toolId:this.id,objectId:this.state.currentRectangle.id})))}this.state={isCreating:!1,startPoint:null,currentRectangle:null,dragTarget:null,dragOffset:null,lockedCorner:null}}}function $e(){return new at}class ct{constructor(){Q(this,"id","area-counter");Q(this,"name","Area Counter");Q(this,"context");Q(this,"badges",new Map);Q(this,"badgeElements",new Map)}init(e){this.context=e,e.events.on("rectangle:created",this.handleRectangleCreated.bind(this)),e.events.on("rectangle:update",this.handleRectangleUpdated.bind(this)),e.events.on("object:removed",this.handleObjectRemoved.bind(this)),this.createBadgesForExistingRectangles();const s=e.state.subscribe(i=>{this.updateBadgePositions()});this.unsubscribeFromState=s}destroy(){this.context.events.off("rectangle:created",this.handleRectangleCreated.bind(this)),this.context.events.off("rectangle:update",this.handleRectangleUpdated.bind(this)),this.context.events.off("object:removed",this.handleObjectRemoved.bind(this)),this.unsubscribeFromState&&this.unsubscribeFromState(),this.badgeElements.forEach(e=>{e.remove()}),this.badgeElements.clear(),this.badges.clear()}createBadgesForExistingRectangles(){this.context.canvas.getAllObjects().forEach(s=>{s.type==="rectangle"&&this.createBadge(s)})}handleRectangleCreated(e){this.createBadge(e.rectangle)}handleRectangleUpdated(e){this.updateBadge(e.rectangle)}handleObjectRemoved(e){this.removeBadge(e.objectId)}createBadge(e){const s={rectangleId:e.id,x:e.properties.x,y:e.properties.y,width:e.properties.width,height:e.properties.height,area:e.properties.area,visible:!0};this.badges.set(e.id,s),this.createBadgeElement(s)}updateBadge(e){const s=this.badges.get(e.id);s&&(s.x=e.properties.x,s.y=e.properties.y,s.width=e.properties.width,s.height=e.properties.height,s.area=e.properties.area,this.updateBadgeElement(s))}removeBadge(e){const s=this.badgeElements.get(e);s&&(s.remove(),this.badgeElements.delete(e)),this.badges.delete(e)}createBadgeElement(e){const s=document.createElement("div");s.className="area-badge",s.style.cssText=`
      position: absolute;
      background: rgba(34, 197, 94, 0.9);
      color: white;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 600;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
      white-space: nowrap;
      pointer-events: none;
      z-index: 1000;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      border: 1px solid rgba(34, 197, 94, 1);
    `,(document.querySelector("[data-grix-canvas]")||document.body).appendChild(s),this.badgeElements.set(e.rectangleId,s),this.updateBadgeElement(e)}updateBadgeElement(e){const s=this.badgeElements.get(e.rectangleId);if(!s)return;const i=e.x+e.width/2,o=e.y+e.height/2,r=this.context.canvas.worldToScreen({x:i,y:o}),c=this.formatArea(e.area,e.width,e.height);s.textContent=c;const d=s.getBoundingClientRect();s.style.left=`${r.x-d.width/2}px`,s.style.top=`${r.y-d.height/2}px`;const x=this.context.state.getState(),f=30,M=e.width*x.viewport.zoom,j=e.height*x.viewport.zoom;s.style.display=M>=f&&j>=f?"block":"none"}formatArea(e,s,i){const o=Math.abs(s-Math.round(s))<.001,r=Math.abs(i-Math.round(i))<.001;if(o&&r){const c=Math.round(s),d=Math.round(i);return`${d} × ${c} = ${d*c}`}return e>=1e3?`${e.toFixed(0)} sq units`:e>=10?`${e.toFixed(1)} sq units`:`${e.toFixed(2)} sq units`}updateBadgePositions(){this.badges.forEach(e=>{this.updateBadgeElement(e)})}showBadge(e){const s=this.badges.get(e);s&&(s.visible=!0,this.updateBadgeElement(s))}hideBadge(e){const s=this.badges.get(e);if(s){s.visible=!1;const i=this.badgeElements.get(e);i&&(i.style.display="none")}}showAllBadges(){this.badges.forEach((e,s)=>{this.showBadge(s)})}hideAllBadges(){this.badges.forEach((e,s)=>{this.hideBadge(s)})}}function Ie(){return new ct}function lt(){const{registerPlugin:t}=ue(),e=y.useRef(!1);return y.useEffect(()=>{if(e.current)return;const s=Fe(),i=$e(),o=Ie();return t(s),t(i),t(o),e.current=!0,()=>{}},[t]),n.jsxs("div",{className:"flex flex-col h-screen bg-gray-50",children:[n.jsx(ze,{}),n.jsx("div",{className:"flex-1 relative","data-grix-canvas":!0,children:n.jsx(De,{width:window.innerWidth,height:window.innerHeight-60,className:"absolute inset-0"})})]})}function dt(){return n.jsx(Re,{children:n.jsx(Se,{children:n.jsx(Re,{children:n.jsx(lt,{})})})})}const ht="0.1.0";X.Canvas=De,X.GrixApp=dt,X.PluginManagerProvider=Se,X.ToolBar=ze,X.createAreaCounter=Ie,X.createRayTool=Fe,X.createRectangleTool=$e,X.useCanvasStore=V,X.useInputSystem=Ee,X.usePluginManager=ue,X.version=ht,Object.defineProperty(X,Symbol.toStringTag,{value:"Module"})});
