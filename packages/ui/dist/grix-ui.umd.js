(function(q,g){typeof exports=="object"&&typeof module<"u"?g(exports,require("react")):typeof define=="function"&&define.amd?define(["exports","react"],g):(q=typeof globalThis<"u"?globalThis:q||self,g(q.GrixUI={},q.React))})(this,function(q,g){"use strict";var lt=Object.defineProperty;var dt=(q,g,te)=>g in q?lt(q,g,{enumerable:!0,configurable:!0,writable:!0,value:te}):q[g]=te;var Q=(q,g,te)=>dt(q,typeof g!="symbol"?g+"":g,te);var te={exports:{}},ce={};/**
 * @license React
 * react-jsx-runtime.production.js
 *
 * Copyright (c) Meta Platforms, Inc. and affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var ye;function Re(){if(ye)return ce;ye=1;var t=Symbol.for("react.transitional.element"),e=Symbol.for("react.fragment");function s(r,o,i){var c=null;if(i!==void 0&&(c=""+i),o.key!==void 0&&(c=""+o.key),"key"in o){i={};for(var l in o)l!=="key"&&(i[l]=o[l])}else i=o;return o=i.ref,{$$typeof:t,type:r,key:c,ref:o!==void 0?o:null,props:i}}return ce.Fragment=e,ce.jsx=s,ce.jsxs=s,ce}var le={};/**
 * @license React
 * react-jsx-runtime.development.js
 *
 * Copyright (c) Meta Platforms, Inc. and affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var ge;function Fe(){return ge||(ge=1,process.env.NODE_ENV!=="production"&&function(){function t(x){if(x==null)return null;if(typeof x=="function")return x.$$typeof===G?null:x.displayName||x.name||null;if(typeof x=="string")return x;switch(x){case P:return"Fragment";case p:return"Profiler";case a:return"StrictMode";case A:return"Suspense";case I:return"SuspenseList";case E:return"Activity"}if(typeof x=="object")switch(typeof x.tag=="number"&&console.error("Received an unexpected object in getComponentNameFromType(). This is likely a bug in React. Please file an issue."),x.$$typeof){case O:return"Portal";case m:return(x.displayName||"Context")+".Provider";case f:return(x._context.displayName||"Context")+".Consumer";case M:var T=x.render;return x=x.displayName,x||(x=T.displayName||T.name||"",x=x!==""?"ForwardRef("+x+")":"ForwardRef"),x;case C:return T=x.displayName||null,T!==null?T:t(x.type)||"Memo";case w:T=x._payload,x=x._init;try{return t(x(T))}catch{}}return null}function e(x){return""+x}function s(x){try{e(x);var T=!1}catch{T=!0}if(T){T=console;var y=T.error,j=typeof Symbol=="function"&&Symbol.toStringTag&&x[Symbol.toStringTag]||x.constructor.name||"Object";return y.call(T,"The provided key is an unsupported type %s. This value must be coerced to a string before using it here.",j),e(x)}}function r(x){if(x===P)return"<>";if(typeof x=="object"&&x!==null&&x.$$typeof===w)return"<...>";try{var T=t(x);return T?"<"+T+">":"<...>"}catch{return"<...>"}}function o(){var x=B.A;return x===null?null:x.getOwner()}function i(){return Error("react-stack-top-frame")}function c(x){if(D.call(x,"key")){var T=Object.getOwnPropertyDescriptor(x,"key").get;if(T&&T.isReactWarning)return!1}return x.key!==void 0}function l(x,T){function y(){X||(X=!0,console.error("%s: `key` is not a prop. Trying to access it will result in `undefined` being returned. If you need to access the same value within the child component, you should pass it as a different prop. (https://react.dev/link/special-props)",T))}y.isReactWarning=!0,Object.defineProperty(x,"key",{get:y,configurable:!0})}function h(){var x=t(this.type);return J[x]||(J[x]=!0,console.error("Accessing element.ref was removed in React 19. ref is now a regular prop. It will be removed from the JSX Element type in a future release.")),x=this.props.ref,x!==void 0?x:null}function b(x,T,y,j,z,R,H,Z){return y=R.ref,x={$$typeof:d,type:x,key:T,props:R,_owner:z},(y!==void 0?y:null)!==null?Object.defineProperty(x,"ref",{enumerable:!1,get:h}):Object.defineProperty(x,"ref",{enumerable:!1,value:null}),x._store={},Object.defineProperty(x._store,"validated",{configurable:!1,enumerable:!1,writable:!0,value:0}),Object.defineProperty(x,"_debugInfo",{configurable:!1,enumerable:!1,writable:!0,value:null}),Object.defineProperty(x,"_debugStack",{configurable:!1,enumerable:!1,writable:!0,value:H}),Object.defineProperty(x,"_debugTask",{configurable:!1,enumerable:!1,writable:!0,value:Z}),Object.freeze&&(Object.freeze(x.props),Object.freeze(x)),x}function v(x,T,y,j,z,R,H,Z){var _=T.children;if(_!==void 0)if(j)if(U(_)){for(j=0;j<_.length;j++)k(_[j]);Object.freeze&&Object.freeze(_)}else console.error("React.jsx: Static children should always be an array. You are likely explicitly calling React.jsxs or React.jsxDEV. Use the Babel transform instead.");else k(_);if(D.call(T,"key")){_=t(x);var S=Object.keys(T).filter(function(N){return N!=="key"});j=0<S.length?"{key: someKey, "+S.join(": ..., ")+": ...}":"{key: someKey}",re[_+j]||(S=0<S.length?"{"+S.join(": ..., ")+": ...}":"{}",console.error(`A props object containing a "key" prop is being spread into JSX:
  let props = %s;
  <%s {...props} />
React keys must be passed directly to JSX without using spread:
  let props = %s;
  <%s key={someKey} {...props} />`,j,_,S,_),re[_+j]=!0)}if(_=null,y!==void 0&&(s(y),_=""+y),c(T)&&(s(T.key),_=""+T.key),"key"in T){y={};for(var W in T)W!=="key"&&(y[W]=T[W])}else y=T;return _&&l(y,typeof x=="function"?x.displayName||x.name||"Unknown":x),b(x,_,R,z,o(),y,H,Z)}function k(x){typeof x=="object"&&x!==null&&x.$$typeof===d&&x._store&&(x._store.validated=1)}var u=g,d=Symbol.for("react.transitional.element"),O=Symbol.for("react.portal"),P=Symbol.for("react.fragment"),a=Symbol.for("react.strict_mode"),p=Symbol.for("react.profiler"),f=Symbol.for("react.consumer"),m=Symbol.for("react.context"),M=Symbol.for("react.forward_ref"),A=Symbol.for("react.suspense"),I=Symbol.for("react.suspense_list"),C=Symbol.for("react.memo"),w=Symbol.for("react.lazy"),E=Symbol.for("react.activity"),G=Symbol.for("react.client.reference"),B=u.__CLIENT_INTERNALS_DO_NOT_USE_OR_WARN_USERS_THEY_CANNOT_UPGRADE,D=Object.prototype.hasOwnProperty,U=Array.isArray,L=console.createTask?console.createTask:function(){return null};u={"react-stack-bottom-frame":function(x){return x()}};var X,J={},se=u["react-stack-bottom-frame"].bind(u,i)(),ne=L(r(i)),re={};le.Fragment=P,le.jsx=function(x,T,y,j,z){var R=1e4>B.recentlyCreatedOwnerStacks++;return v(x,T,y,!1,j,z,R?Error("react-stack-top-frame"):se,R?L(r(x)):ne)},le.jsxs=function(x,T,y,j,z){var R=1e4>B.recentlyCreatedOwnerStacks++;return v(x,T,y,!0,j,z,R?Error("react-stack-top-frame"):se,R?L(r(x)):ne)}}()),le}var me;function $e(){return me||(me=1,process.env.NODE_ENV==="production"?te.exports=Re():te.exports=Fe()),te.exports}var n=$e();const oe={distance(t,e){const s=e.x-t.x,r=e.y-t.y;return Math.sqrt(s*s+r*r)},slope(t,e){const s=e.x-t.x,r=e.y-t.y;return Math.abs(s)<Number.EPSILON?s===0||s>0?1/0:-1/0:r/s},angle(t,e){const s=e.x-t.x,r=e.y-t.y;return Math.atan2(r,s)},magnitude(t){return Math.sqrt(t.x*t.x+t.y*t.y)},normalize(t){const e=this.magnitude(t);return e===0?{x:0,y:0}:{x:t.x/e,y:t.y/e}},snapToGrid(t,e){return{x:Math.round(t.x/e)*e,y:Math.round(t.y/e)*e}},calculateArea(t){return Math.abs(t.properties.width*t.properties.height)},boundsContainPoint(t,e){return e.x>=t.x&&e.x<=t.x+t.width&&e.y>=t.y&&e.y<=t.y+t.height},boundsIntersect(t,e){return!(t.x+t.width<e.x||e.x+e.width<t.x||t.y+t.height<e.y||e.y+e.height<t.y)},gcd(t,e){for(t=Math.abs(t),e=Math.abs(e);e!==0;){const s=e;e=t%e,t=s}return t},simplifyFraction(t,e){if(e===0)return[t,1];const s=this.gcd(t,e);return[t/s,e/s]},worldToScreen(t,e,s){const r=s.width/2,o=s.height/2,i=(t.x-e.center.x)*e.zoom,c=(t.y-e.center.y)*e.zoom;return{x:r+i,y:o-c}},screenToWorld(t,e,s){const r=s.width/2,o=s.height/2,i=(t.x-r)/e.zoom,c=(o-t.y)/e.zoom;return{x:e.center.x+i,y:e.center.y+c}}},ae={detectCapabilities(){const t="ontouchstart"in window||navigator.maxTouchPoints>0,e=t&&navigator.maxTouchPoints>1,s=!0,r=window.matchMedia("(hover: hover)").matches;return{hasTouch:t,hasPencil:e,hasKeyboard:s,hasHover:r,maxTouchPoints:navigator.maxTouchPoints||0,supportsPressure:"force"in Touch.prototype,supportsTilt:"altitudeAngle"in Touch.prototype}},normalizePointerEvent(t){let e="mouse";return t.pointerType==="touch"?e="touch":t.pointerType==="pen"&&(e="pen"),{type:e,pressure:t.pressure||0,tiltX:t.tiltX||0,tiltY:t.tiltY||0,x:t.clientX,y:t.clientY,timestamp:t.timeStamp,isPrimary:t.isPrimary,pointerId:t.pointerId}},getTouchTargetSize(t){switch(t){case"pen":return 32;case"touch":return 44;case"mouse":return 24;default:return 44}}};class Ie{constructor(){this.listeners=new Map}on(e,s){this.listeners.has(e)||this.listeners.set(e,[]),this.listeners.get(e).push(s)}off(e,s){const r=this.listeners.get(e);if(r){const o=r.indexOf(s);o>-1&&r.splice(o,1)}}emit(e,s){const r=this.listeners.get(e);r&&r.forEach(o=>{try{o(s)}catch(i){console.error(`Error in event handler for ${e}:`,i)}})}clear(){this.listeners.clear()}getEvents(){return Array.from(this.listeners.keys())}getListenerCount(e){var s;return((s=this.listeners.get(e))==null?void 0:s.length)||0}}const be=t=>{let e;const s=new Set,r=(b,v)=>{const k=typeof b=="function"?b(e):b;if(!Object.is(k,e)){const u=e;e=v??(typeof k!="object"||k===null)?k:Object.assign({},e,k),s.forEach(d=>d(e,u))}},o=()=>e,l={setState:r,getState:o,getInitialState:()=>h,subscribe:b=>(s.add(b),()=>s.delete(b))},h=e=t(r,o,l);return l},We=t=>t?be(t):be,Le=t=>t;function Ye(t,e=Le){const s=g.useSyncExternalStore(t.subscribe,()=>e(t.getState()),()=>e(t.getInitialState()));return g.useDebugValue(s),s}const je=t=>{const e=We(t),s=r=>Ye(e,r);return Object.assign(s,e),s},ue=t=>t?je(t):je,V=ue((t,e)=>({viewport:{center:{x:0,y:0},zoom:20,bounds:{x:-10,y:-10,width:20,height:20}},objects:[],selectedObjects:[],snapToGrid:!0,gridDensity:"fine",canvasSize:{width:800,height:600},setViewport:s=>{t(r=>({viewport:{...r.viewport,...s}}))},addObject:s=>{t(r=>({objects:[...r.objects,s]}))},removeObject:s=>{t(r=>({objects:r.objects.filter(o=>o.id!==s),selectedObjects:r.selectedObjects.filter(o=>o!==s)}))},updateObject:(s,r)=>{t(o=>({objects:o.objects.map(i=>i.id===s?{...i,...r}:i)}))},selectObject:(s,r=!1)=>{t(o=>r?{selectedObjects:o.selectedObjects.includes(s)?o.selectedObjects.filter(c=>c!==s):[...o.selectedObjects,s]}:{selectedObjects:[s]})},clearSelection:()=>{t({selectedObjects:[]})},setSnapToGrid:s=>{t({snapToGrid:s})},setGridDensity:s=>{t({gridDensity:s})},setCanvasSize:s=>{t({canvasSize:s})},getObject:s=>e().objects.find(r=>r.id===s),getAllObjects:()=>e().objects,getSelectedObjects:()=>{const s=e();return s.objects.filter(r=>s.selectedObjects.includes(r.id))},screenToWorld:s=>{const{viewport:r,canvasSize:o}=e();return oe.screenToWorld(s,r,o)},worldToScreen:s=>{const{viewport:r,canvasSize:o}=e();return oe.worldToScreen(s,r,o)}})),_e=()=>({addObject:t=>V.getState().addObject(t),removeObject:t=>V.getState().removeObject(t),updateObject:(t,e)=>V.getState().updateObject(t,e),getObject:t=>V.getState().getObject(t),getAllObjects:()=>V.getState().getAllObjects(),screenToWorld:t=>V.getState().screenToWorld(t),worldToScreen:t=>V.getState().worldToScreen(t)}),Ge=()=>({getState:()=>{const t=V.getState();return{viewport:t.viewport,objects:t.objects,selectedObjects:t.selectedObjects,snapToGrid:t.snapToGrid,gridDensity:t.gridDensity}},setState:t=>{V.setState(t)},subscribe:t=>V.subscribe(e=>{t({viewport:e.viewport,objects:e.objects,selectedObjects:e.selectedObjects,snapToGrid:e.snapToGrid,gridDensity:e.gridDensity})})}),ve=g.createContext(null);function de(){const t=g.useContext(ve);if(!t)throw new Error("usePluginManager must be used within PluginManagerProvider");return t}function Me({children:t}){const[e]=g.useState(()=>new Ie),[s]=g.useState(()=>new Map),[r]=g.useState(()=>new Map),[o,i]=g.useState(null),c=g.useRef(),l=g.useRef(),h=g.useRef();c.current||(c.current=_e()),l.current||(l.current=Ge()),h.current||(h.current={distance:oe.distance,slope:oe.slope,snapToGrid:oe.snapToGrid,calculateArea:oe.calculateArea});const b=c.current,v=l.current,k=h.current,u=a=>{if(s.has(a.id)){console.warn(`Plugin ${a.id} is already registered`);return}const p={canvas:b,events:e,state:v,math:k};s.set(a.id,a),r.set(a.id,p);try{a.init(p),console.log(`Plugin ${a.id} initialized successfully`)}catch(f){console.error(`Failed to initialize plugin ${a.id}:`,f),s.delete(a.id),r.delete(a.id)}},d=a=>{var f;const p=s.get(a);if(p){try{(f=p.destroy)==null||f.call(p)}catch(m){console.error(`Error destroying plugin ${a}:`,m)}s.delete(a),r.delete(a),o===a&&i(null)}},O=()=>Array.from(s.values());g.useEffect(()=>{e.emit("tool:changed",{previous:null,current:o})},[o,e]),g.useEffect(()=>{const a=M=>A=>{var C,w,E,G,B,D;const I=o?s.get(o):null;if(I)try{switch(M){case"pointer:down":(C=I.onPointerDown)==null||C.call(I,A);break;case"pointer:move":(w=I.onPointerMove)==null||w.call(I,A);break;case"pointer:up":(E=I.onPointerUp)==null||E.call(I,A);break}}catch(U){console.error(`Error in plugin ${o} handling ${M}:`,U)}else{const U=v.getState().selectedObjects;try{let L;if(U.length===1){const X=b.getObject(U[0]);(X==null?void 0:X.type)==="ray"?L=s.get("ray-tool"):(X==null?void 0:X.type)==="rectangle"&&(L=s.get("rectangle-tool"))}if(L)switch(M){case"pointer:down":(G=L.onPointerDown)==null||G.call(L,A);break;case"pointer:move":(B=L.onPointerMove)==null||B.call(L,A);break;case"pointer:up":(D=L.onPointerUp)==null||D.call(L,A);break}}catch(L){console.error(`Error in tool handling ${M} for manipulation:`,L)}}},p=a("pointer:down"),f=a("pointer:move"),m=a("pointer:up");return e.on("pointer:down",p),e.on("pointer:move",f),e.on("pointer:up",m),()=>{e.off("pointer:down",p),e.off("pointer:move",f),e.off("pointer:up",m)}},[o,s,e]);const P={eventBus:e,registerPlugin:u,unregisterPlugin:d,getActivePlugins:O,activeTool:o,setActiveTool:i};return n.jsx(ve.Provider,{value:P,children:t})}function Be(){const{eventBus:t}=de();return{handlePointerDown:o=>{t.emit("pointer:down",o)},handlePointerMove:o=>{t.emit("pointer:move",o)},handlePointerUp:o=>{t.emit("pointer:up",o)}}}function Pe(t,e,s={}){const[r,o]=g.useState(null),[i,c]=g.useState(new Map),l={enableGestures:!0,touchTargetSize:44,preventScrolling:!0,...s};g.useEffect(()=>{const a=ae.detectCapabilities();o(a)},[]);const[h,b]=g.useState({isGesturing:!1,startTime:0,startDistance:0,lastTapTime:0,tapCount:0}),v=g.useCallback(a=>{const p=Array.from(a.values());if(p.length<2)return 0;const f=p[0],m=p[1];if(!f||!m)return 0;const M=f.x-m.x,A=f.y-m.y;return Math.sqrt(M*M+A*A)},[]),k=g.useCallback(a=>{const p=Array.from(a.values());if(p.length===0)return{x:0,y:0};const f=p.reduce((m,M)=>({x:m.x+M.x,y:m.y+M.y}),{x:0,y:0});return{x:f.x/p.length,y:f.y/p.length}},[]),u=g.useCallback(a=>{var A;if(!t.current)return;l.preventScrolling&&a.preventDefault();const p=t.current.getBoundingClientRect(),f=a.clientX-p.left,m=a.clientY-p.top,M=ae.normalizePointerEvent(a);M.x=f,M.y=m,c(I=>{const C=new Map(I);if(C.set(a.pointerId,M),l.enableGestures&&C.size>=2){const w=v(C);b(E=>({...E,isGesturing:!0,startTime:a.timeStamp,startDistance:w}))}return C}),t.current.setPointerCapture(a.pointerId),(A=e.onPointerDown)==null||A.call(e,M)},[t,e,l,v]),d=g.useCallback(a=>{var A;if(!t.current)return;const p=t.current.getBoundingClientRect(),f=a.clientX-p.left,m=a.clientY-p.top,M=ae.normalizePointerEvent(a);M.x=f,M.y=m,c(I=>{var w,E;const C=new Map(I);if(C.set(a.pointerId,M),l.enableGestures&&C.size>=2){const G=v(C),B=k(C);if(h.isGesturing&&h.startDistance>0){const D=G/h.startDistance;(w=e.onGesture)==null||w.call(e,{type:"pinch",center:B,scale:D,touches:C.size})}}else if(C.size===1&&h.isGesturing){const G=k(C);(E=e.onGesture)==null||E.call(e,{type:"pan",center:G,touches:C.size})}return C}),(A=e.onPointerMove)==null||A.call(e,M)},[e,l,v,k,h]),O=g.useCallback(a=>{var A;if(!t.current)return;const p=t.current.getBoundingClientRect(),f=a.clientX-p.left,m=a.clientY-p.top,M=ae.normalizePointerEvent(a);M.x=f,M.y=m,c(I=>{var w;const C=new Map(I);if(C.delete(a.pointerId),l.enableGestures&&C.size===0){const G=a.timeStamp-h.startTime<200,B=a.timeStamp-h.lastTapTime;G&&!h.isGesturing&&(B<300?b(D=>({...D,tapCount:D.tapCount+1})):((w=e.onGesture)==null||w.call(e,{type:"tap",center:{x:M.x,y:M.y},touches:1}),b(D=>({...D,tapCount:1,lastTapTime:a.timeStamp})))),b(D=>({...D,isGesturing:!1}))}return C}),t.current&&t.current.releasePointerCapture(a.pointerId),(A=e.onPointerUp)==null||A.call(e,M)},[t,e,l,h]),P=g.useCallback(a=>{var A;if(!t.current)return;const p=t.current.getBoundingClientRect(),f=a.clientX-p.left,m=a.clientY-p.top,M=ae.normalizePointerEvent(a);M.x=f,M.y=m,c(I=>{const C=new Map(I);return C.delete(a.pointerId),C}),b(I=>({...I,isGesturing:!1})),(A=e.onPointerCancel)==null||A.call(e,M)},[e]);return g.useEffect(()=>{const a=t.current;if(!a)return;a.addEventListener("pointerdown",u),a.addEventListener("pointermove",d),a.addEventListener("pointerup",O),a.addEventListener("pointercancel",P);const p=f=>f.preventDefault();return a.addEventListener("contextmenu",p),()=>{a.removeEventListener("pointerdown",u),a.removeEventListener("pointermove",d),a.removeEventListener("pointerup",O),a.removeEventListener("pointercancel",P),a.removeEventListener("contextmenu",p)}},[t,u,d,O,P]),{capabilities:r,activePointers:Array.from(i.values()),isGesturing:h.isGesturing,touchTargetSize:r?ae.getTouchTargetSize(r.hasTouch?"touch":"mouse"):l.touchTargetSize}}function Xe(t,e={minSpacing:8,maxSpacing:80,labelMinSpacing:40}){const s=t.zoom;let o=1,i=o*s;for(;i<e.minSpacing&&o<1e4;)o*=we(o),i=o*s;for(;i>e.maxSpacing&&o>1e-4;)o/=qe(o),i=o*s;let c=o,l=c*s;for(;l<e.labelMinSpacing&&c<o*100;)c*=we(c),l=c*s;const h=Math.max(.1,Math.min(1,(i-e.minSpacing)/(e.maxSpacing-e.minSpacing)));return{gridSize:o,labelStep:c,shouldShowGrid:i>=e.minSpacing,shouldShowLabels:l>=e.labelMinSpacing,opacity:h}}function we(t){if(t<1)return t>=.5?2:t>=.2?2.5:(t>=.1,2);if(t<10)return t>=5?2:t>=2?2.5:(t>=1,2);{const e=Math.pow(10,Math.floor(Math.log10(t))),s=t/e;return s>=5?2:s>=2?2.5:(s>=1,2)}}function qe(t){if(t<=1)return t<=.1||t<=.2?2:t<=.5?2.5:(t<=1,2);if(t<=10)return t<=2?2:t<=5?2.5:(t<=10,2);{const e=Math.pow(10,Math.floor(Math.log10(t))),s=t/e;return s<=2?2:s<=5?2.5:(s<=10,2)}}function Ue(t,e,s,r,o=!0){const{gridSize:i}=s,c={left:t.center.x-e.width/2/t.zoom,right:t.center.x+e.width/2/t.zoom,top:t.center.y+e.height/2/t.zoom,bottom:t.center.y-e.height/2/t.zoom},l=[],h=[],b=Math.floor(c.left/i)*i,v=Math.ceil(c.right/i)*i;for(let d=b;d<=v;d+=i){const O=r({x:d,y:0}).x,P=Math.abs(d)<i/2,a=Math.abs(d%(i*5))<i/2;l.push({x:O,isAxis:P,isMajor:a,isInteger:!1,value:d})}if(i>=2&&o){const d=Math.floor(c.left),O=Math.ceil(c.right);for(let P=d;P<=O;P+=1)if(Math.abs(P%i)>.001){const a=r({x:P,y:0}).x,p=Math.abs(P)<.5;l.push({x:a,isAxis:p,isMajor:!1,isInteger:!0,value:P})}}const k=Math.floor(c.bottom/i)*i,u=Math.ceil(c.top/i)*i;for(let d=k;d<=u;d+=i){const O=r({x:0,y:d}).y,P=Math.abs(d)<i/2,a=Math.abs(d%(i*5))<i/2;h.push({y:O,isAxis:P,isMajor:a,isInteger:!1,value:d})}if(i>=2&&o){const d=Math.floor(c.bottom),O=Math.ceil(c.top);for(let P=d;P<=O;P+=1)if(Math.abs(P%i)>.001){const a=r({x:0,y:P}).y,p=Math.abs(P)<.5;h.push({y:a,isAxis:p,isMajor:!1,isInteger:!0,value:P})}}return{verticalLines:l,horizontalLines:h}}function F(t,e){return e>=1?t.toFixed(0):e>=.1?t.toFixed(1):e>=.01?t.toFixed(2):t.toFixed(3)}const Se={showEquivalentFractions:!0,showLengthMultiples:!0,showAreaRectangle:!0,showRiseRunTriangle:!1,showDistanceMarkers:!1,showAngleArc:!1,showDivisionAnswer:!0,showLatticePoints:!1,showIntegerGridLines:!0,showReferenceLineY_equals_X:!0,fontScale:1,gridScale:1,snapPrecision:"adaptive",coordinateSystem:"cartesian",showPolarGrid:!1,customOrigin:null},xe=ue(t=>({...Se,toggleSetting:e=>{t(s=>({[e]:!s[e]}))},setFontScale:e=>{t({fontScale:e})},setGridScale:e=>{t({gridScale:e})},setSnapPrecision:e=>{t({snapPrecision:e})},setCoordinateSystem:e=>{t({coordinateSystem:e})},setCustomOrigin:e=>{t({customOrigin:e})},resetToDefaults:()=>{t(Se)}}));function He({viewport:t,canvasSize:e,worldToScreen:s,objects:r=[]}){const o=xe(),i=a=>Math.round(a*o.fontScale),c=Xe(t,{minSpacing:8,maxSpacing:80,labelMinSpacing:40}),l={gridSize:c.gridSize/o.gridScale,labelStep:c.labelStep/o.gridScale},{verticalLines:h,horizontalLines:b}=Ue(t,e,l,s,o.showIntegerGridLines);if(!c.shouldShowGrid)return null;const v=[];if(o.coordinateSystem==="polar"||o.coordinateSystem==="both"){const a=s({x:0,y:0}),p=Math.max(Math.abs(t.center.x)+e.width/(2*t.zoom),Math.abs(t.center.y)+e.height/(2*t.zoom));for(let f=l.gridSize;f<=p;f+=l.gridSize){const m=f*t.zoom;m>=10&&v.push(n.jsx("circle",{cx:a.x,cy:a.y,r:m,fill:"none",stroke:"#9CA3AF",strokeWidth:"0.5",opacity:.4},`polar-circle-${f}`))}for(let f=0;f<360;f+=30){const m=f*Math.PI/180,M=a.x+p*t.zoom*Math.cos(m),A=a.y-p*t.zoom*Math.sin(m);v.push(n.jsx("line",{x1:a.x,y1:a.y,x2:M,y2:A,stroke:"#9CA3AF",strokeWidth:"0.5",opacity:.3},`polar-line-${f}`))}}const k=[];r.forEach(a=>{if(a.type==="ray"){const{startPoint:p,endPoint:f}=a.properties;if(Math.abs(p.x)<.001&&Math.abs(p.y)<.001){const m=f.x-p.x,M=f.y-p.y;if(Math.abs(m)>.001){const A=1/m;if(A>0&&A<=1){const I=p.y+A*M,C=s({x:1,y:I});k.push({y:I,screenY:C.y})}}}}});const u=h.map(a=>{const p=Math.abs(a.value-1)<.001,f=a.isAxis?"#374151":p?"#60A5FA":a.isInteger?"#E5E7EB":a.isMajor?"#9CA3AF":"#E5E7EB",m=a.isAxis?2:p?1.5:a.isInteger?Math.max(1,t.zoom*.05):a.isMajor?1:.5,M=a.isAxis?1:p?.8:a.isInteger?Math.max(.6,.4*c.opacity):a.isMajor?.6*c.opacity:.3*c.opacity;return n.jsx("line",{x1:a.x,y1:0,x2:a.x,y2:e.height,stroke:f,strokeWidth:m,opacity:M},`v${a.value}`)}),d=b.map(a=>n.jsx("line",{x1:0,y1:a.y,x2:e.width,y2:a.y,stroke:a.isAxis?"#374151":a.isInteger?"#E5E7EB":a.isMajor?"#9CA3AF":"#E5E7EB",strokeWidth:a.isAxis?2:a.isInteger?Math.max(1,t.zoom*.05):a.isMajor?1:.5,opacity:a.isAxis?1:a.isInteger?Math.max(.6,.4*c.opacity):a.isMajor?.6*c.opacity:.3*c.opacity},`h${a.value}`)),O=o.showReferenceLineY_equals_X?(()=>{const a={left:t.center.x-e.width/2/t.zoom,right:t.center.x+e.width/2/t.zoom,top:t.center.y+e.height/2/t.zoom,bottom:t.center.y-e.height/2/t.zoom},p=Math.min(a.left,a.bottom),f=Math.max(a.right,a.top),m=s({x:p,y:p}),M=s({x:f,y:f});return{lineStart:m,lineEnd:M}})():null,P=o.showLatticePoints?(()=>{const a={left:t.center.x-e.width/2/t.zoom,right:t.center.x+e.width/2/t.zoom,top:t.center.y+e.height/2/t.zoom,bottom:t.center.y-e.height/2/t.zoom},p=[],f=Math.max(-20,Math.floor(a.left)),m=Math.min(20,Math.ceil(a.right)),M=Math.max(-20,Math.floor(a.bottom)),A=Math.min(20,Math.ceil(a.top)),I=(m-f+1)*(A-M+1);if(I>200){const C=Math.ceil(Math.sqrt(I/200));for(let w=f;w<=m;w+=C)for(let E=M;E<=A;E+=C){const G=s({x:w,y:E});G.x>=-20&&G.x<=e.width+20&&G.y>=-20&&G.y<=e.height+20&&p.push(G)}}else for(let C=f;C<=m;C++)for(let w=M;w<=A;w++){const E=s({x:C,y:w});E.x>=-20&&E.x<=e.width+20&&E.y>=-20&&E.y<=e.height+20&&p.push(E)}return p})():[];return n.jsxs("g",{className:"grid",children:[(o.coordinateSystem==="polar"||o.coordinateSystem==="both")&&n.jsx("g",{className:"polar-grid",children:v}),(o.coordinateSystem==="cartesian"||o.coordinateSystem==="both")&&n.jsxs("g",{className:"cartesian-grid",children:[u,d]}),P.map((a,p)=>n.jsx("circle",{cx:a.x,cy:a.y,r:"1.5",fill:"#9CA3AF",opacity:"0.3"},`lattice-${p}`)),O&&n.jsx("line",{x1:O.lineStart.x,y1:O.lineStart.y,x2:O.lineEnd.x,y2:O.lineEnd.y,stroke:"#A78BFA",strokeWidth:"1.5",opacity:"0.6",strokeDasharray:"5,5"}),c.shouldShowLabels&&n.jsxs("g",{className:"labels",fontSize:"12",fill:"#374151",children:[h.filter(a=>{const p=Math.abs(a.value%l.labelStep)<l.gridSize/10,f=Math.abs(a.value)>=l.labelStep/2;return p&&f}).filter((a,p,f)=>!f.slice(0,p).some(m=>Math.abs(m.value-a.value)<.001)).map(a=>n.jsx("text",{x:a.x,y:s({x:0,y:0}).y+20,textAnchor:"middle",fontSize:i(11),fontWeight:"500",opacity:Math.max(.7,c.opacity),children:F(a.value,c.gridSize)},`xlabel${a.value}`)),b.filter(a=>{const p=Math.abs(a.value%l.labelStep)<l.gridSize/10,f=Math.abs(a.value)>=l.labelStep/2;return p&&f}).filter((a,p,f)=>!f.slice(0,p).some(m=>Math.abs(m.value-a.value)<.001)).map(a=>n.jsx("text",{x:s({x:0,y:0}).x-15,y:a.y+4,textAnchor:"middle",fontSize:i(11),fontWeight:"500",opacity:Math.max(.7,c.opacity),children:F(a.value,c.gridSize)},`ylabel${a.value}`)),n.jsx("text",{x:s({x:0,y:0}).x-25,y:s({x:0,y:0}).y-10,fontSize:i(11),fontWeight:"600",fill:"#374151",opacity:Math.max(.8,c.opacity),children:"(0,0)"}),o.showDivisionAnswer&&k.map((a,p)=>{const f=s({x:1,y:0}).x;return n.jsxs("g",{children:[n.jsx("circle",{cx:f,cy:a.screenY,r:"4",fill:"white",stroke:"#60A5FA",strokeWidth:"2",opacity:"0.9"}),n.jsxs("text",{x:f+15,y:a.screenY+4,fontSize:i(10),fontWeight:"600",fill:"#60A5FA",opacity:"0.9",children:["y = ",a.y.toFixed(2)]})]},`ray-intersection-${p}`)})]})]})}function Ze({viewport:t,onZoomIn:e,onZoomOut:s,onZoomReset:r,onCenterOnly:o}){const[i,c]=g.useState(0),l=g.useRef(null),h=()=>{const b=Date.now();b-i<500?(l.current&&(clearTimeout(l.current),l.current=null),r()):l.current=window.setTimeout(()=>{o(),l.current=null},300),c(b)};return n.jsxs("div",{className:"absolute bottom-4 right-4 flex flex-col gap-2",children:[n.jsx("button",{onClick:e,className:"w-10 h-10 bg-white/90 hover:bg-white border border-gray-300 rounded-lg shadow-md flex items-center justify-center text-gray-700 font-bold transition-colors",title:"Zoom in (Ctrl+scroll up)",disabled:t.zoom>=1e3,children:"+"}),n.jsx("button",{onClick:s,className:"w-10 h-10 bg-white/90 hover:bg-white border border-gray-300 rounded-lg shadow-md flex items-center justify-center text-gray-700 font-bold transition-colors",title:"Zoom out (Ctrl+scroll down)",disabled:t.zoom<=.01,children:"âˆ’"}),n.jsx("button",{onClick:h,className:"w-10 h-10 bg-white/90 hover:bg-white border border-gray-300 rounded-lg shadow-md flex items-center justify-center text-gray-600 text-xs transition-colors",title:"Center view (single click) or Reset zoom (double click)",children:"âŒ‚"}),n.jsxs("div",{className:"w-10 h-6 bg-white/90 border border-gray-300 rounded text-xs flex items-center justify-center text-gray-600",children:[t.zoom>=1?Math.round(t.zoom):t.zoom.toFixed(1),"Ã—"]})]})}function Ke({objects:t,viewport:e,touchTargetSize:s,worldToScreen:r,selectedObjects:o=[],canvasSize:i}){const c=xe(),l=u=>Math.round(u*c.fontScale),h=e.zoom>50?.1:e.zoom>10?1:10,[b,v]=g.useState(null),k=u=>{const d=o.includes(u.id);switch(u.type){case"ray":const O=r(u.properties.startPoint),P=r(u.properties.endPoint);return n.jsxs("g",{children:[d&&n.jsx("line",{x1:O.x,y1:O.y,x2:P.x,y2:P.y,stroke:"#60A5FA",strokeWidth:6,opacity:.4}),n.jsx("line",{x1:O.x,y1:O.y,x2:P.x,y2:P.y,stroke:d?"#1D4ED8":"#2563eb",strokeWidth:d?3:2}),n.jsx("circle",{cx:O.x,cy:O.y,r:s/4,fill:d?"#1D4ED8":"#2563eb",stroke:d?"#60A5FA":"none",strokeWidth:d?2:0,style:{cursor:"move"},onMouseEnter:()=>v(`${u.id}-start`),onMouseLeave:()=>v(null)}),n.jsx("circle",{cx:P.x,cy:P.y,r:s/4,fill:d?"#1D4ED8":"#2563eb",stroke:d?"#60A5FA":"none",strokeWidth:d?2:0,style:{cursor:"move"},onMouseEnter:()=>v(`${u.id}-end`),onMouseLeave:()=>v(null)}),!(Math.abs(u.properties.startPoint.x)<.001&&Math.abs(u.properties.startPoint.y)<.001)&&b===`${u.id}-start`&&n.jsxs("text",{x:O.x-5,y:O.y-10,fontSize:l(10),fontWeight:"500",fill:d?"#1D4ED8":"#2563eb",textAnchor:"middle",opacity:"0.8",children:["(",F(u.properties.startPoint.x,h),", ",F(u.properties.startPoint.y,h),")"]}),b===`${u.id}-end`&&n.jsxs("text",{x:Math.abs(u.properties.startPoint.x)<.001&&Math.abs(u.properties.startPoint.y)<.001?P.x-60:P.x+5,y:Math.abs(u.properties.startPoint.x)<.001&&Math.abs(u.properties.startPoint.y)<.001?P.y+4:P.y-10,fontSize:l(10),fontWeight:"500",fill:d?"#1D4ED8":"#2563eb",textAnchor:Math.abs(u.properties.startPoint.x)<.001&&Math.abs(u.properties.startPoint.y)<.001?"end":"middle",opacity:"0.8",children:["(",F(u.properties.endPoint.x,h),", ",F(u.properties.endPoint.y,h),")"]}),(()=>{const C=u.properties.endPoint.x-u.properties.startPoint.x;u.properties.endPoint.y-u.properties.startPoint.y;const w=Math.abs(u.properties.startPoint.x)<.001&&Math.abs(u.properties.startPoint.y)<.001;if(Math.abs(C)>.001){const E=P.x,G=P.y;if(w){const B=u.properties.endPoint.x,D=u.properties.endPoint.y,U=F(D,h),L=F(B,h);return n.jsxs("g",{children:[n.jsx("text",{x:E+15,y:G-25,fontSize:l(9),fontWeight:"500",fill:d?"#1D4ED8":"#2563eb",textAnchor:"middle",opacity:"0.8",children:U}),n.jsx("line",{x1:E+8,y1:G-19,x2:E+22,y2:G-19,stroke:d?"#1D4ED8":"#2563eb",strokeWidth:"1",opacity:"0.8"}),n.jsx("text",{x:E+15,y:G-9,fontSize:l(9),fontWeight:"500",fill:d?"#1D4ED8":"#2563eb",textAnchor:"middle",opacity:"0.8",children:L})]})}else return null}return null})(),(()=>{if(!(Math.abs(u.properties.startPoint.x)<.001&&Math.abs(u.properties.startPoint.y)<.001))return null;const w=u.properties.endPoint.x,E=u.properties.endPoint.y;if(Math.abs(w)<.001&&Math.abs(E)<.001)return null;const G=w,B=E,D={left:e.center.x-i.width/2/e.zoom,right:e.center.x+i.width/2/e.zoom,top:e.center.y+i.height/2/e.zoom,bottom:e.center.y-i.height/2/e.zoom},U=Math.max(Math.abs(D.left),Math.abs(D.right),Math.abs(D.top),Math.abs(D.bottom))*2,L=Math.sqrt(G*G+B*B);if(L===0)return null;const X=G/L,J=B/L,se={x:U*X,y:U*J},ne=r(se),re=[];if(Math.abs(w)>.001&&Math.abs(E)>.001){const y=E/w;for(let j=1;j<=Math.min(20,Math.abs(U));j++){const z=y*j,R=Math.round(j/.25)*.25,H=Math.round(z/.25)*.25;if(Math.abs(j-R)<.1&&Math.abs(z-H)<.1&&Math.abs(R)<=U&&Math.abs(H)<=U){const Z=r({x:R,y:H});Z.x>=-100&&Z.x<=i.width+100&&Z.y>=-100&&Z.y<=i.height+100&&re.push({world:{x:R,y:H},screen:Z,fraction:{num:F(H,h),den:F(R,h)}})}}}const x=Math.sqrt(w*w+E*E),T=[];if(x>0&&c.showLengthMultiples)for(let y=2;y<=5;y++){const j=w*y,z=E*y,R=r({x:j,y:z});R.x>=-50&&R.x<=i.width+50&&R.y>=-50&&R.y<=i.height+50&&T.push({screen:R,multiple:y})}return n.jsxs("g",{children:[c.showEquivalentFractions&&n.jsx("line",{x1:P.x,y1:P.y,x2:ne.x,y2:ne.y,stroke:d?"#1D4ED8":"#2563eb",strokeWidth:"1",opacity:"0.3",strokeDasharray:"3,3"}),T.map((y,j)=>n.jsxs("g",{children:[n.jsx("circle",{cx:y.screen.x,cy:y.screen.y,r:"2",fill:d?"#1D4ED8":"#2563eb",opacity:"0.4"}),n.jsxs("text",{x:y.screen.x+8,y:y.screen.y-8,fontSize:l(7),fontWeight:"400",fill:d?"#1D4ED8":"#2563eb",textAnchor:"start",opacity:"0.5",children:["Ã—",y.multiple]})]},`length-${j}`)),c.showAreaRectangle&&(()=>{if(w>0&&E>0){const y=r({x:0,y:0}),j=r({x:w,y:E}),z=Math.abs(j.x-y.x),R=Math.abs(j.y-y.y),H=Math.min(y.x,j.x),Z=Math.min(y.y,j.y),_=w*E;return n.jsxs("g",{children:[n.jsx("rect",{x:H,y:Z,width:z,height:R,fill:d?"#1D4ED8":"#2563eb",opacity:"0.08",stroke:d?"#1D4ED8":"#2563eb",strokeWidth:"0.5",strokeOpacity:"0.15"}),n.jsxs("text",{x:H+z/2,y:Z+15,fontSize:l(10),fontWeight:"400",fill:d?"#1D4ED8":"#2563eb",textAnchor:"middle",opacity:"0.6",children:[F(E,h)," Ã— ",F(w,h)," = ",F(_,h)]})]})}return null})(),c.showRiseRunTriangle&&(()=>{if(w>0&&E>0){const y=r({x:0,y:0}),j=r({x:w,y:0}),z=r({x:w,y:E});return n.jsxs("g",{children:[n.jsx("path",{d:`M ${y.x},${y.y} L ${j.x},${j.y} L ${z.x},${z.y} Z`,fill:"none",stroke:d?"#1D4ED8":"#2563eb",strokeWidth:"1",opacity:"0.4",strokeDasharray:"2,2"}),n.jsxs("text",{x:j.x+10,y:(j.y+z.y)/2,fontSize:l(9),fontWeight:"500",fill:d?"#1D4ED8":"#2563eb",textAnchor:"start",opacity:"0.7",children:["rise: ",F(E,h)]}),n.jsxs("text",{x:(y.x+j.x)/2,y:j.y+8,fontSize:l(9),fontWeight:"500",fill:d?"#1D4ED8":"#2563eb",textAnchor:"middle",opacity:"0.7",children:["run: ",F(w,h)]})]})}return null})(),c.showDistanceMarkers&&(()=>{const y=[],j=Math.sqrt(w*w+E*E);if(j>0){const z=r({x:0,y:0});let R=Math.atan2(E,w);R<0&&(R=R+2*Math.PI);const H=[];for(let _=1;_<=Math.floor(j);_++)H.push({radius:_,isUnit:!0});H.push({radius:j,isUnit:!1}),H.forEach(({radius:_,isUnit:S},W)=>{const N=_*e.zoom;if(N>=15&&N<=800&&Math.abs(R)>.05){const Y=R>Math.PI?1:0,K=`M ${z.x+N},${z.y} A ${N},${N} 0 ${Y},0 ${z.x+N*Math.cos(R)},${z.y-N*Math.sin(R)}`;y.push(n.jsx("path",{d:K,fill:"none",stroke:d?"#1D4ED8":"#2563eb",strokeWidth:S?"1":"1.5",opacity:S?"0.3":"0.6",strokeDasharray:S?"2,2":"none"},`radial-${u.id}-${_.toFixed(3)}-${R.toFixed(3)}-${W}`))}});const Z=r({x:j,y:0});y.push(n.jsxs("g",{children:[n.jsx("path",{d:`M ${Z.x},${z.y} L ${Z.x-4},${z.y+8} L ${Z.x+4},${z.y+8} Z`,fill:d?"#1D4ED8":"#2563eb",opacity:"0.7"}),n.jsxs("text",{x:Z.x-15,y:z.y-8,fontSize:l(8),fontWeight:"600",fill:d?"#1D4ED8":"#2563eb",textAnchor:"end",opacity:"0.8",children:["d = ",j.toFixed(2)]})]},`distance-${u.id}`))}return n.jsx("g",{children:y})})(),c.showAngleArc&&(()=>{let y=Math.atan2(E,w);if(y<0&&(y=y+2*Math.PI),Math.abs(w)>.05||Math.abs(E)>.05){const j=r({x:0,y:0}),z=50,R=(y*180/Math.PI).toFixed(1),H=y,Z=y>Math.PI?1:0,_=`M ${j.x+z},${j.y} A ${z},${z} 0 ${Z},0 ${j.x+z*Math.cos(H)},${j.y-z*Math.sin(H)}`,S=y/2,W=z*.7,N=j.x+W*Math.cos(S),Y=j.y-W*Math.sin(S);return n.jsxs("g",{children:[n.jsx("path",{d:_,fill:"none",stroke:d?"#1D4ED8":"#2563eb",strokeWidth:"2",opacity:"0.6"}),n.jsxs("text",{x:N,y:Y,fontSize:l(11),fontWeight:"600",fill:d?"#1D4ED8":"#2563eb",textAnchor:"middle",opacity:"0.8",children:["Î¸ = ",R,"Â°"]})]})}return null})(),c.showEquivalentFractions&&re.map((y,j)=>{const R=Math.abs(y.world.x-1)<.1&&c.showDivisionAnswer,H=Math.abs(y.world.x-w)<.1&&Math.abs(y.world.y-E)<.1;return R||H?null:n.jsxs("g",{children:[n.jsx("circle",{cx:y.screen.x,cy:y.screen.y,r:"4",fill:"white",stroke:"#22C55E",strokeWidth:"2",opacity:"0.8"}),n.jsxs("text",{x:y.screen.x+15,y:y.screen.y+4,fontSize:l(9),fontWeight:"500",fill:"#22C55E",textAnchor:"start",opacity:"0.8",children:[y.fraction.num,"/",y.fraction.den]})]},`equiv-${j}`)})]})})(),d&&(()=>{const C=u.properties.endPoint.x,w=u.properties.endPoint.y;if(!(Math.abs(u.properties.startPoint.x)<.001&&Math.abs(u.properties.startPoint.y)<.001))return null;const G=Math.sqrt(C*C+w*w),B=Math.atan2(w,C),D=G+1,U=r({x:D*Math.cos(B),y:D*Math.sin(B)}),L=[.5,2].map(X=>({factor:X,pos:r({x:C*X,y:w*X})}));return n.jsxs("g",{className:"transformation-handles",children:[n.jsx("circle",{cx:U.x,cy:U.y,r:"6",fill:"white",stroke:"#F59E0B",strokeWidth:"2",opacity:"0.9",style:{cursor:"grab"},className:"transform-handle rotation-handle"}),n.jsx("text",{x:U.x,y:U.y+2,fontSize:l(8),fontWeight:"600",fill:"#F59E0B",textAnchor:"middle",opacity:"0.8",style:{pointerEvents:"none"},children:"â†»"}),L.map(({factor:X,pos:J})=>n.jsxs("g",{children:[n.jsx("circle",{cx:J.x,cy:J.y,r:"5",fill:"white",stroke:"#8B5CF6",strokeWidth:"2",opacity:"0.8",style:{cursor:"nesw-resize"},className:"transform-handle scale-handle","data-scale-factor":X}),n.jsxs("text",{x:J.x,y:J.y+1,fontSize:l(6),fontWeight:"600",fill:"#8B5CF6",textAnchor:"middle",opacity:"0.7",style:{pointerEvents:"none"},children:[X,"Ã—"]})]},`scale-${X}`)),[1,-1].map(X=>{const J=B+Math.PI/2,se=r({x:C*.75+X*.8*Math.cos(J),y:w*.75+X*.8*Math.sin(J)});return n.jsx("circle",{cx:se.x,cy:se.y,r:"4",fill:"white",stroke:"#EC4899",strokeWidth:"2",opacity:"0.7",style:{cursor:"pointer"},className:"transform-handle reflection-handle","data-reflection-axis":X===1?"perpendicular":"parallel"},`reflect-${X}`)})]})})()]},u.id);case"rectangle":const a=r({x:u.properties.x,y:u.properties.y+u.properties.height}),p=u.properties.width*e.zoom,f=u.properties.height*e.zoom,m={x:u.properties.x,y:u.properties.y},M={x:u.properties.x+u.properties.width,y:u.properties.y},A={x:u.properties.x,y:u.properties.y+u.properties.height},I={x:u.properties.x+u.properties.width,y:u.properties.y+u.properties.height};return n.jsxs("g",{children:[d&&n.jsx("rect",{x:a.x-3,y:a.y-3,width:p+6,height:f+6,fill:"none",stroke:"#60A5FA",strokeWidth:4,opacity:.5,style:{cursor:"pointer"}}),n.jsx("rect",{x:a.x,y:a.y,width:p,height:f,fill:d?"rgba(34, 197, 94, 0.3)":"rgba(34, 197, 94, 0.2)",stroke:d?"#16A34A":"#22c55e",strokeWidth:d?3:2,style:{cursor:"pointer"}}),n.jsx("circle",{cx:a.x,cy:a.y,r:s/6,fill:d?"#16A34A":"#22c55e",stroke:d?"#60A5FA":"none",strokeWidth:d?2:0,style:{cursor:"nw-resize"}}),n.jsx("circle",{cx:a.x+p,cy:a.y,r:s/6,fill:d?"#16A34A":"#22c55e",stroke:d?"#60A5FA":"none",strokeWidth:d?2:0,style:{cursor:"ne-resize"}}),n.jsx("circle",{cx:a.x,cy:a.y+f,r:s/6,fill:d?"#16A34A":"#22c55e",stroke:d?"#60A5FA":"none",strokeWidth:d?2:0,style:{cursor:"sw-resize"}}),n.jsx("circle",{cx:a.x+p,cy:a.y+f,r:s/6,fill:d?"#16A34A":"#22c55e",stroke:d?"#60A5FA":"none",strokeWidth:d?2:0,style:{cursor:"se-resize"}}),n.jsxs("text",{x:a.x-10,y:a.y-5,fontSize:l(9),fontWeight:"500",fill:"#22c55e",textAnchor:"end",opacity:"0.8",children:["(",F(A.x,h),", ",F(A.y,h),")"]}),n.jsxs("text",{x:a.x+p+10,y:a.y-5,fontSize:l(9),fontWeight:"500",fill:"#22c55e",textAnchor:"start",opacity:"0.8",children:["(",F(I.x,h),", ",F(I.y,h),")"]}),n.jsxs("text",{x:a.x-10,y:a.y+f+15,fontSize:l(9),fontWeight:"500",fill:"#22c55e",textAnchor:"end",opacity:"0.8",children:["(",F(m.x,h),", ",F(m.y,h),")"]}),n.jsxs("text",{x:a.x+p+10,y:a.y+f+15,fontSize:l(9),fontWeight:"500",fill:"#22c55e",textAnchor:"start",opacity:"0.8",children:["(",F(M.x,h),", ",F(M.y,h),")"]}),n.jsxs("text",{x:a.x+p/2,y:a.y+f/2,fontSize:l(12),fontWeight:"600",fill:"#22c55e",textAnchor:"middle",opacity:"0.9",children:[F(u.properties.height,h)," Ã— ",F(u.properties.width,h)," = ",F(u.properties.area,h)]})]},u.id);default:return null}};return n.jsxs(n.Fragment,{children:[n.jsx("defs",{}),n.jsx("g",{className:"objects",children:t.map(k)})]})}function Je({capabilities:t,viewport:e,activeTool:s,selectedObjectsCount:r}){return t?n.jsxs("div",{className:"absolute top-2 left-2 text-xs text-gray-500 bg-white/80 p-2 rounded shadow-sm",children:[n.jsxs("div",{children:["Input: ",t.hasTouch?"ðŸ‘†":"ðŸ–±ï¸"," ",t.hasPencil?"âœï¸":""]}),n.jsxs("div",{children:["Zoom: ",e.zoom>=1?e.zoom.toFixed(1):e.zoom.toFixed(2),"Ã—"]}),n.jsxs("div",{children:["Center: (",e.center.x.toFixed(1),", ",e.center.y.toFixed(1),")"]}),n.jsxs("div",{children:["Tool: ",s||"Pan Mode"]}),r>0&&n.jsxs("div",{children:["Selected: ",r," object",r!==1?"s":""]})]}):null}function Qe({selectedObject:t,onDelete:e,onClose:s}){if(!t)return null;const r=()=>{e(),s()},o=()=>{switch(t.type){case"ray":const{startPoint:i,endPoint:c,slope:l}=t.properties,h=Math.abs(i.x)<.001&&Math.abs(i.y)<.001;return n.jsxs("div",{className:"space-y-2",children:[n.jsx("div",{className:"text-sm font-medium text-gray-700",children:"Line Details"}),n.jsxs("div",{className:"space-y-1 text-xs text-gray-600",children:[n.jsxs("div",{children:["Start: (",F(i.x,1),", ",F(i.y,1),")"]}),n.jsxs("div",{children:["End: (",F(c.x,1),", ",F(c.y,1),")"]}),h&&n.jsxs("div",{children:["Fraction: ",Math.round(c.y),"/",Math.round(c.x)]}),n.jsxs("div",{children:["Slope: ",isFinite(l)?l.toFixed(3):"undefined"]})]})]});case"rectangle":const{x:b,y:v,width:k,height:u,area:d}=t.properties;return n.jsxs("div",{className:"space-y-2",children:[n.jsx("div",{className:"text-sm font-medium text-gray-700",children:"Rectangle Details"}),n.jsxs("div",{className:"space-y-1 text-xs text-gray-600",children:[n.jsxs("div",{children:["Position: (",F(b,1),", ",F(v,1),")"]}),n.jsxs("div",{children:["Size: ",F(k,1)," Ã— ",F(u,1)]}),n.jsxs("div",{children:["Area: ",F(d,1)]})]})]});default:return null}};return n.jsxs("div",{className:"fixed top-4 right-4 bg-white border border-gray-200 rounded-lg shadow-lg p-3 z-50 min-w-48",children:[o(),n.jsxs("div",{className:"mt-3 pt-2 border-t border-gray-100 flex gap-2",children:[n.jsxs("button",{onClick:r,className:"flex items-center gap-1 px-2 py-1 text-xs text-red-600 hover:bg-red-50 rounded transition-colors",children:[n.jsx("span",{children:"ðŸ—‘ï¸"}),"Delete"]}),n.jsxs("button",{onClick:s,className:"flex items-center gap-1 px-2 py-1 text-xs text-gray-600 hover:bg-gray-50 rounded transition-colors",children:[n.jsx("span",{children:"âœ•"}),"Close"]})]})]})}function Ve(){const[t,e]=g.useState(!1),s=g.useRef(null),r=xe(),{toggleSetting:o,setFontScale:i,setGridScale:c,setSnapPrecision:l,setCoordinateSystem:h,resetToDefaults:b}=r;g.useEffect(()=>{function k(u){s.current&&!s.current.contains(u.target)&&e(!1)}if(t)return document.addEventListener("mousedown",k),()=>{document.removeEventListener("mousedown",k)}},[t]);const v=[{title:"Origin Lines",subtitle:"Enhancements for lines from (0,0)",settings:[{key:"showEquivalentFractions",label:"Equivalent Fractions",description:"Green circles showing equivalent fractions"},{key:"showLengthMultiples",label:"Length Multiples",description:"Small dots at 2Ã—, 3Ã—, 4Ã— line length"},{key:"showAreaRectangle",label:"Area Rectangle",description:"Soft rectangle showing multiplication"},{key:"showRiseRunTriangle",label:"Rise/Run Triangle",description:"Triangle showing slope components"},{key:"showDistanceMarkers",label:"Distance Markers",description:"Radial quarter-circles at unit distances"},{key:"showAngleArc",label:"Angle Arc",description:"Arc showing angle from x-axis with measurement"}]},{title:"Division & Fractions",subtitle:"Visual fraction and division concepts",settings:[{key:"showDivisionAnswer",label:"Division Answer (x=1 line)",description:"Blue dot showing y-value at x=1"}]},{title:"Grid & Reference",subtitle:"Grid enhancements and reference lines",settings:[{key:"showLatticePoints",label:"Lattice Points",description:"Dots at all integer coordinates"},{key:"showIntegerGridLines",label:"Integer Grid Lines",description:"Faint lines at whole numbers"},{key:"showReferenceLineY_equals_X",label:"y=x Reference Line",description:"Purple diagonal line for comparison"}]},{title:"Display",subtitle:"Adjust visibility for classrooms and large screens",settings:[]}];return n.jsxs("div",{ref:s,className:"fixed bottom-4 left-4 z-50",children:[n.jsxs("button",{onClick:()=>e(!t),className:"flex items-center gap-2 px-3 py-2 bg-white border border-gray-200 rounded-lg shadow-sm hover:bg-gray-50 transition-colors",title:"Visualization Settings",children:[n.jsx("span",{className:"text-lg",children:"âš™ï¸"}),n.jsx("span",{className:"text-sm font-medium text-gray-700",children:"Settings"}),n.jsx("span",{className:`text-xs transition-transform ${t?"":"rotate-180"}`,children:"â–¼"})]}),t&&n.jsxs("div",{className:"absolute bottom-full left-0 mb-2 bg-white border border-gray-200 rounded-lg shadow-lg w-80 max-h-[28rem] overflow-y-auto",children:[n.jsx("div",{className:"sticky top-0 bg-white border-b border-gray-100 px-4 py-3 rounded-t-lg",children:n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsx("h3",{className:"text-sm font-semibold text-gray-800",children:"Visualization Settings"}),n.jsx("button",{onClick:b,className:"text-xs text-blue-600 hover:text-blue-800 font-medium",children:"Reset All"})]})}),n.jsx("div",{className:"p-4 space-y-5",children:v.map((k,u)=>n.jsxs("div",{children:[n.jsxs("div",{className:`${u>0?"border-t border-gray-100 pt-4":""} mb-3`,children:[n.jsx("h4",{className:"text-xs font-semibold text-gray-700 uppercase tracking-wide",children:k.title}),k.subtitle&&n.jsx("p",{className:"text-xs text-gray-500 mt-0.5",children:k.subtitle})]}),n.jsxs("div",{className:"space-y-2.5",children:[k.settings.map(d=>n.jsxs("label",{className:"flex items-start gap-3 cursor-pointer group",children:[n.jsx("input",{type:"checkbox",checked:r[d.key],onChange:()=>o(d.key),className:"mt-0.5 w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500 focus:ring-2"}),n.jsxs("div",{className:"flex-1 min-w-0",children:[n.jsx("div",{className:"text-sm font-medium text-gray-700 group-hover:text-gray-900",children:d.label}),n.jsx("div",{className:"text-xs text-gray-500 leading-relaxed",children:d.description})]})]},d.key)),k.title==="Display"&&n.jsxs("div",{className:"space-y-3",children:[n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsx("label",{className:"text-sm font-medium text-gray-700",children:"Font Size"}),n.jsxs("span",{className:"text-xs text-gray-500 font-mono",children:[Math.round(r.fontScale*100),"%"]})]}),n.jsxs("div",{className:"flex items-center gap-3",children:[n.jsx("span",{className:"text-xs text-gray-400",children:"A"}),n.jsx("input",{type:"range",min:"0.8",max:"2.0",step:"0.1",value:r.fontScale,onChange:d=>i(parseFloat(d.target.value)),className:"flex-1 h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer slider"}),n.jsx("span",{className:"text-sm text-gray-600",children:"A"})]}),n.jsx("div",{className:"text-xs text-gray-500 leading-relaxed",children:"Increase font size for better visibility on TVs and projectors"}),n.jsxs("div",{className:"space-y-3 pt-4 border-t border-gray-100",children:[n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsx("label",{className:"text-sm font-medium text-gray-700",children:"Grid Density"}),n.jsxs("span",{className:"text-xs text-gray-500 font-mono",children:[Math.round(r.gridScale*100),"%"]})]}),n.jsxs("div",{className:"flex items-center gap-3",children:[n.jsx("span",{className:"text-xs text-gray-400",children:"Sparse"}),n.jsx("input",{type:"range",min:"0.2",max:"5.0",step:"0.1",value:r.gridScale,onChange:d=>c(parseFloat(d.target.value)),className:"flex-1 h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer slider"}),n.jsx("span",{className:"text-xs text-gray-600",children:"Dense"})]}),n.jsx("div",{className:"text-xs text-gray-500 leading-relaxed",children:"Adjust grid line spacing for different zoom levels and detail needs"})]}),n.jsxs("div",{className:"space-y-3 pt-4 border-t border-gray-100",children:[n.jsx("label",{className:"text-sm font-medium text-gray-700",children:"Coordinate System"}),n.jsx("div",{className:"space-y-2",children:[{value:"cartesian",label:"Cartesian Only",desc:"Standard x-y grid"},{value:"polar",label:"Polar Only",desc:"Circular coordinate system"},{value:"both",label:"Both Systems",desc:"Overlay polar on Cartesian"}].map(d=>n.jsxs("label",{className:"flex items-start gap-3 cursor-pointer group",children:[n.jsx("input",{type:"radio",name:"coordinateSystem",value:d.value,checked:r.coordinateSystem===d.value,onChange:O=>h(O.target.value),className:"mt-0.5 w-4 h-4 text-blue-600 border-gray-300 focus:ring-blue-500"}),n.jsxs("div",{className:"flex-1 min-w-0",children:[n.jsx("div",{className:"text-sm font-medium text-gray-700 group-hover:text-gray-900",children:d.label}),n.jsx("div",{className:"text-xs text-gray-500",children:d.desc})]})]},d.value))})]}),n.jsxs("div",{className:"space-y-3 pt-4 border-t border-gray-100",children:[n.jsx("label",{className:"text-sm font-medium text-gray-700",children:"Snap Precision"}),n.jsx("div",{className:"space-y-2",children:[{value:"adaptive",label:"Adaptive",desc:"Automatically adjusts based on zoom level"},{value:"whole",label:"Whole Numbers",desc:"Snap to 1, 2, 3, etc."},{value:"half",label:"Half Units",desc:"Snap to 0.5, 1.0, 1.5, etc."},{value:"quarter",label:"Quarter Units",desc:"Snap to 0.25, 0.5, 0.75, etc."},{value:"tenth",label:"Tenth Units",desc:"Snap to 0.1, 0.2, 0.3, etc."}].map(d=>n.jsxs("label",{className:"flex items-start gap-3 cursor-pointer group",children:[n.jsx("input",{type:"radio",name:"snapPrecision",value:d.value,checked:r.snapPrecision===d.value,onChange:O=>l(O.target.value),className:"mt-0.5 w-4 h-4 text-blue-600 border-gray-300 focus:ring-blue-500"}),n.jsxs("div",{className:"flex-1 min-w-0",children:[n.jsx("div",{className:"text-sm font-medium text-gray-700 group-hover:text-gray-900",children:d.label}),n.jsx("div",{className:"text-xs text-gray-500",children:d.desc})]})]},d.value))}),n.jsx("div",{className:"text-xs text-gray-500 leading-relaxed",children:"Controls where objects can be placed when snap-to-grid is enabled"})]})]})]})]},k.title))}),n.jsx("div",{className:"sticky bottom-0 bg-gray-50 border-t border-gray-100 px-4 py-2 rounded-b-lg",children:n.jsx("p",{className:"text-xs text-gray-500 text-center",children:"Toggle features to explore different mathematical concepts"})})]})]})}const Ee=(t,e)=>{const s=e*Math.PI/180,r=Math.cos(s),o=Math.sin(s);return{x:t.x*r-t.y*o,y:t.x*o+t.y*r}},et=(t,e)=>({x:t.x*e,y:t.y*e}),Ce=(t,e)=>{switch(e){case"x":return{x:t.x,y:-t.y};case"y":return{x:-t.x,y:t.y};case"origin":return{x:-t.x,y:-t.y};default:return t}},tt=ue((t,e)=>({isTransforming:!1,activeTransform:null,selectedObject:null,rotateObject:(s,r,o)=>{if(!o){console.log(`No canvas API provided for rotation of ${s}`);return}const i=o.getObject(s);if(i){if(i.type==="ray"){if(Math.abs(i.properties.startPoint.x)<.001&&Math.abs(i.properties.startPoint.y)<.001){const l=Ee(i.properties.endPoint,r);o.updateObject(s,{properties:{...i.properties,endPoint:l}})}}else if(i.type==="rectangle"){const c=i.properties.x+i.properties.width/2,l=i.properties.y+i.properties.height/2,h={x:i.properties.x-c,y:i.properties.y-l},b=Ee(h,r);o.updateObject(s,{properties:{...i.properties,x:b.x+c,y:b.y+l}})}}},scaleObject:(s,r,o)=>{if(!o){console.log(`No canvas API provided for scaling of ${s}`);return}const i=o.getObject(s);if(i)if(i.type==="ray"){if(Math.abs(i.properties.startPoint.x)<.001&&Math.abs(i.properties.startPoint.y)<.001){const l=et(i.properties.endPoint,r);o.updateObject(s,{properties:{...i.properties,endPoint:l}})}}else i.type==="rectangle"&&o.updateObject(s,{properties:{...i.properties,width:i.properties.width*r,height:i.properties.height*r,area:i.properties.width*r*i.properties.height*r}})},reflectObject:(s,r,o)=>{if(!o){console.log(`No canvas API provided for reflection of ${s}`);return}const i=o.getObject(s);if(i){if(i.type==="ray"){if(Math.abs(i.properties.startPoint.x)<.001&&Math.abs(i.properties.startPoint.y)<.001){const l=Ce(i.properties.endPoint,r);o.updateObject(s,{properties:{...i.properties,endPoint:l}})}}else if(i.type==="rectangle"){const c=Ce({x:i.properties.x,y:i.properties.y},r);o.updateObject(s,{properties:{...i.properties,x:c.x,y:c.y}})}}},rotate90:(s,r)=>{e().rotateObject(s,90,r)},rotate180:(s,r)=>{e().rotateObject(s,180,r)},rotate270:(s,r)=>{e().rotateObject(s,270,r)},setActiveTransform:s=>{t({activeTransform:s,isTransforming:s!==null})},setSelectedObject:s=>{t({selectedObject:s})},clearTransform:()=>{t({isTransforming:!1,activeTransform:null,selectedObject:null})}}));function st(t,e,s){const r=s.x-e.x,o=s.y-e.y,i=Math.sqrt(r*r+o*o);if(i===0)return Math.sqrt(Math.pow(t.x-e.x,2)+Math.pow(t.y-e.y,2));const c=Math.max(0,Math.min(1,((t.x-e.x)*r+(t.y-e.y)*o)/(i*i))),l={x:e.x+c*r,y:e.y+c*o};return Math.sqrt(Math.pow(t.x-l.x,2)+Math.pow(t.y-l.y,2))}function ke({width:t=800,height:e=600,className:s="",onObjectInteraction:r}){const o=g.useRef(null),{viewport:i,setViewport:c,objects:l,selectedObjects:h,snapToGrid:b,gridDensity:v,canvasSize:k,setCanvasSize:u,removeObject:d,clearSelection:O,selectObject:P,screenToWorld:a,worldToScreen:p}=V(),f=Be(),{activeTool:m,setActiveTool:M,eventBus:A}=de(),{rotate90:I,rotate180:C,rotate270:w,scaleObject:E,setSelectedObject:G}=tt();g.useEffect(()=>{u({width:t,height:e})},[t,e,u]);const B=g.useRef({isPanning:!1,startPoint:{x:0,y:0},startCenter:{x:0,y:0}}),D=g.useRef({isDown:!1,startPoint:{x:0,y:0},hasMoved:!1,dragThreshold:5,pendingSelection:null}),[U,L]=g.useState(null),[X,J]=g.useState(!1),se=g.useCallback(S=>{const W={x:S.x,y:S.y};D.current={isDown:!0,startPoint:W,hasMoved:!1,dragThreshold:5,pendingSelection:null};const N=22;a(W);let Y=!1;for(const $ of l)if($.type==="ray"){const K=p($.properties.startPoint),ee=p($.properties.endPoint),ie=Math.sqrt(Math.pow(W.x-K.x,2)+Math.pow(W.y-K.y,2)),he=Math.sqrt(Math.pow(W.x-ee.x,2)+Math.pow(W.y-ee.y,2));if(ie<=N||he<=N){Y=!0,D.current.pendingSelection={objectId:$.id,type:"ray"},P($.id);break}if(st(W,K,ee)<=8){Y=!0,D.current.pendingSelection={objectId:$.id,type:"ray"},P($.id);break}}else if($.type==="rectangle"){const K=p({x:$.properties.x,y:$.properties.y+$.properties.height}),ee=$.properties.width*i.zoom,ie=$.properties.height*i.zoom;if(W.x>=K.x&&W.x<=K.x+ee&&W.y>=K.y&&W.y<=K.y+ie){Y=!0,D.current.pendingSelection={objectId:$.id,type:"rectangle"},P($.id);break}if([{x:K.x,y:K.y},{x:K.x+ee,y:K.y},{x:K.x,y:K.y+ie},{x:K.x+ee,y:K.y+ie}].some(fe=>Math.sqrt(Math.pow(W.x-fe.x,2)+Math.pow(W.y-fe.y,2))<=N)){Y=!0,D.current.pendingSelection={objectId:$.id,type:"rectangle"},P($.id);break}}(!Y&&!m||!Y&&m)&&O(),(m||Y)&&f.handlePointerDown(S),!Y&&!m&&(S.type==="touch"||S.type==="mouse")&&(B.current={isPanning:!0,startPoint:{x:S.x,y:S.y},startCenter:{...i.center}})},[i.center,f,m,M,l,a,p,i.zoom]),ne=g.useCallback(S=>{const W={x:S.x,y:S.y};if(S.type==="mouse"&&m?L(W):m||L(null),D.current.isDown&&!D.current.hasMoved){const N=Math.abs(S.x-D.current.startPoint.x),Y=Math.abs(S.y-D.current.startPoint.y);Math.sqrt(N*N+Y*Y)>=D.current.dragThreshold&&(D.current.hasMoved=!0,D.current.pendingSelection=null)}if(f.handlePointerMove(S),!m&&B.current.isPanning){const N=(S.x-B.current.startPoint.x)/i.zoom,Y=(S.y-B.current.startPoint.y)/i.zoom;c({center:{x:B.current.startCenter.x-N,y:B.current.startCenter.y+Y}})}},[i.zoom,c,f,m,L]),re=g.useCallback(S=>{D.current={isDown:!1,startPoint:{x:0,y:0},hasMoved:!1,dragThreshold:5,pendingSelection:null},f.handlePointerUp(S),B.current.isPanning=!1},[f,M]),x=g.useCallback(S=>{switch(S.type){case"pinch":if(S.scale){const W=Math.max(.1,Math.min(10,i.zoom*S.scale));c({zoom:W})}break}},[i.zoom,c]),{capabilities:T,touchTargetSize:y}=Pe(o,{onPointerDown:se,onPointerMove:ne,onPointerUp:re,onGesture:x},{enableGestures:!0,preventScrolling:!0});g.useEffect(()=>{const S=N=>{switch(N.key){case"Escape":m&&(A.emit("tool:cancel",{toolId:m}),M(null));break;case"Delete":case"Backspace":h.length>0&&(console.log("Deleting objects:",h),h.forEach(Y=>{A.emit("object:removed",{objectId:Y}),d(Y)}),O(),M(null));break;case"r":case"R":if(h.length>0&&!N.ctrlKey){N.preventDefault();const Y={getObject,updateObject};h.forEach($=>{N.shiftKey?w($,Y):I($,Y)})}break;case"f":case"F":if(h.length>0&&!N.ctrlKey){N.preventDefault();const Y={getObject,updateObject};h.forEach($=>{C($,Y)})}break;case"=":case"+":if(h.length>0&&!N.ctrlKey){N.preventDefault();const Y={getObject,updateObject};h.forEach($=>{E($,2,Y)})}break;case"-":case"_":if(h.length>0&&!N.ctrlKey){N.preventDefault();const Y={getObject,updateObject};h.forEach($=>{E($,.5,Y)})}break}},W=N=>{console.log("Object created, returning to pan mode:",N),O(),M(null)};return document.addEventListener("keydown",S),A.on("tool:creation-complete",W),()=>{document.removeEventListener("keydown",S),A.off("tool:creation-complete",W)}},[m,M,A,h,d,O]),g.useEffect(()=>{h.length===1?J(!0):J(!1)},[h]);const j=g.useCallback(()=>{J(!1)},[]),z=g.useCallback(()=>{h.length>0&&(h.forEach(S=>{A.emit("object:removed",{objectId:S}),d(S)}),O())},[h,d,O,A]),R=g.useCallback(()=>{const S=Math.min(1e3,i.zoom*1.4);c({zoom:S})},[i.zoom,c]),H=g.useCallback(()=>{const S=Math.max(.01,i.zoom/1.4);c({zoom:S})},[i.zoom,c]),Z=g.useCallback(()=>{c({zoom:20,center:{x:0,y:0}})},[c]),_=g.useCallback(()=>{c({center:{x:0,y:0}})},[c]);return g.useEffect(()=>{const S=N=>{N.preventDefault();const $=V.getState().viewport;if(N.ctrlKey||N.metaKey){const K=N.deltaY>0?.9:1.1,ee=Math.max(.01,Math.min(1e3,$.zoom*K));c({zoom:ee})}else{const ee=N.shiftKey?N.deltaY:0,ie=N.shiftKey?0:N.deltaY,he=ee*1/$.zoom,pe=ie*1/$.zoom;c({center:{x:$.center.x+he,y:$.center.y-pe}})}},W=o.current;if(W)return W.addEventListener("wheel",S,{passive:!1}),()=>{W.removeEventListener("wheel",S)}},[c]),n.jsxs("div",{className:`relative ${s}`,style:{width:t,height:e},children:[n.jsxs("svg",{ref:o,width:t,height:e,className:"absolute inset-0 bg-white",style:{touchAction:"none"},children:[n.jsx(He,{viewport:i,canvasSize:{width:t,height:e},worldToScreen:p,objects:l}),n.jsx(Ke,{objects:l,viewport:i,touchTargetSize:y,worldToScreen:p,selectedObjects:h,canvasSize:{width:t,height:e}}),m&&U&&!D.current.isDown&&n.jsx("circle",{cx:U.x,cy:U.y,r:"4",fill:"rgba(37, 99, 235, 0.4)",stroke:"#2563eb",strokeWidth:"1",opacity:"0.8",style:{pointerEvents:"none"}})]}),n.jsx(Je,{capabilities:T,viewport:i,activeTool:m,selectedObjectsCount:h.length}),n.jsx(Ze,{viewport:i,onZoomIn:R,onZoomOut:H,onZoomReset:Z,onCenterOnly:_}),X&&h.length===1&&n.jsx(Qe,{selectedObject:l.find(S=>S.id===h[0])||null,onDelete:z,onClose:j}),n.jsx(Ve,{})]})}const Oe=[{id:"ray-tool",name:"Line Builder",icon:"ðŸ“",description:"Create and edit lines to explore slopes and fractions"},{id:"rectangle-tool",name:"Rectangle Builder",icon:"â¬œ",description:"Create rectangles to explore area and multiplication"}];function Ae({className:t=""}){const{activeTool:e,setActiveTool:s}=de(),[r,o]=g.useState(!1),i=g.useRef(null),c=v=>{s(v),o(!1)},l=()=>{s(null),o(!1)},h=()=>{o(!r)},b=Oe.find(v=>v.id===e);return g.useEffect(()=>{const v=k=>{i.current&&!i.current.contains(k.target)&&o(!1)};return r&&document.addEventListener("mousedown",v),()=>{document.removeEventListener("mousedown",v)}},[r]),n.jsxs("div",{className:`flex items-center gap-2 p-2 bg-white border-b border-gray-200 ${t}`,children:[n.jsxs("div",{className:"flex items-center gap-2 mr-4",children:[n.jsx("div",{className:"text-2xl",children:"ðŸŸ¦"}),n.jsx("h1",{className:"text-lg font-semibold text-gray-800",children:"Grix"})]}),n.jsxs("div",{className:"relative",ref:i,children:[n.jsxs("button",{onClick:h,className:`
            flex items-center gap-2 px-4 py-2 rounded-lg border transition-all
            ${e?"bg-blue-100 border-blue-300 text-blue-700":"bg-gray-50 border-gray-200 text-gray-700 hover:bg-gray-100"}
          `,children:[n.jsx("span",{className:"text-lg",children:"ðŸ—ï¸"}),n.jsx("span",{className:"text-sm font-medium",children:b?b.name:"Build"}),n.jsx("span",{className:`text-xs transition-transform ${r?"rotate-180":""}`,children:"â–¼"})]}),r&&n.jsxs("div",{className:"absolute top-full left-0 mt-1 bg-white border border-gray-200 rounded-lg shadow-lg z-50 min-w-48",children:[Oe.map(v=>n.jsxs("button",{onClick:()=>c(v.id),className:`
                  w-full flex items-center gap-3 px-4 py-3 text-left hover:bg-gray-50 first:rounded-t-lg last:rounded-b-lg transition-colors
                  ${e===v.id?"bg-blue-50 text-blue-700":"text-gray-700"}
                `,title:v.description,children:[n.jsx("span",{className:"text-lg",children:v.icon}),n.jsxs("div",{children:[n.jsx("div",{className:"text-sm font-medium",children:v.name}),n.jsx("div",{className:"text-xs text-gray-500",children:v.description})]})]},v.id)),e&&n.jsxs(n.Fragment,{children:[n.jsx("div",{className:"border-t border-gray-100"}),n.jsxs("button",{onClick:l,className:"w-full flex items-center gap-3 px-4 py-2 text-left hover:bg-gray-50 rounded-b-lg transition-colors text-gray-600",children:[n.jsx("span",{className:"text-lg",children:"âœ•"}),n.jsx("span",{className:"text-sm",children:"Clear selection"})]})]})]})]}),n.jsx("div",{className:"ml-auto flex items-center gap-4 text-sm text-gray-500",children:e?n.jsxs("span",{className:"flex items-center gap-1",children:[n.jsx("div",{className:"w-2 h-2 bg-green-400 rounded-full"}),(b==null?void 0:b.name)||"Active Tool"]}):n.jsxs("span",{className:"flex items-center gap-1",children:[n.jsx("div",{className:"w-2 h-2 bg-gray-300 rounded-full"}),"Click Build to start creating"]})})]})}class Te extends g.Component{constructor(e){super(e),this.state={hasError:!1}}static getDerivedStateFromError(e){return{hasError:!0,error:e}}componentDidCatch(e,s){console.error("Canvas Error Boundary caught an error:",e,s),this.setState({error:e,errorInfo:s})}render(){var e,s;if(this.state.hasError){const r=this.props.fallback;return r?n.jsx(r,{error:this.state.error}):n.jsx("div",{className:"flex items-center justify-center h-full bg-red-50 text-red-700 p-8",children:n.jsxs("div",{className:"text-center",children:[n.jsx("h2",{className:"text-xl font-semibold mb-4",children:"Something went wrong with the Canvas"}),n.jsxs("details",{className:"text-sm",children:[n.jsx("summary",{className:"cursor-pointer mb-2",children:"Error Details"}),n.jsxs("pre",{className:"whitespace-pre-wrap text-left bg-red-100 p-4 rounded",children:[(e=this.state.error)==null?void 0:e.toString(),(s=this.state.errorInfo)==null?void 0:s.componentStack]})]}),n.jsx("button",{onClick:()=>window.location.reload(),className:"mt-4 px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700",children:"Reload Page"})]})})}return this.props.children}}class nt{constructor(){Q(this,"id","ray-tool");Q(this,"name","Line Builder");Q(this,"context");Q(this,"state",{isCreating:!1,startPoint:null,currentRay:null,dragTarget:null,dragOffset:null})}init(e){this.context=e,e.events.on("tool:changed",this.handleToolChange.bind(this)),e.events.on("tool:cancel",this.handleToolCancel.bind(this))}destroy(){this.context.events.off("tool:changed",this.handleToolChange.bind(this)),this.context.events.off("tool:cancel",this.handleToolCancel.bind(this))}handleToolChange(e){e.current!==this.id&&this.cancelCreation()}handleToolCancel(e){e.toolId===this.id&&this.cancelCreation()}cancelCreation(){this.state.currentRay&&this.state.isCreating&&this.context.canvas.removeObject(this.state.currentRay.id),this.state={isCreating:!1,startPoint:null,currentRay:null,dragTarget:null,dragOffset:null}}generateId(){return`ray_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}snapPoint(e){const s=this.context.state.getState();if(s.snapToGrid){const r=s.viewport;let o;return r.zoom>=50?o=.1:r.zoom>=20?o=.25:r.zoom>=10?o=.5:o=s.gridDensity==="fine"?1:10,this.context.math.snapToGrid(e,o)}return e}findNearestHandle(e,s=20){this.context.canvas.screenToWorld(e);const r=this.context.canvas.getAllObjects();for(const o of r)if(o.type==="ray"){const i=o,c=this.context.canvas.worldToScreen(i.properties.startPoint),l=this.context.canvas.worldToScreen(i.properties.endPoint),h=this.context.math.distance(e,c),b=this.context.math.distance(e,l);if(h<=s)return{rayId:i.id,handle:"start"};if(b<=s)return{rayId:i.id,handle:"end"};const v=8,k=l.x-c.x,u=l.y-c.y,d=Math.sqrt(k*k+u*u);if(d>0){const O=Math.max(0,Math.min(1,((e.x-c.x)*k+(e.y-c.y)*u)/(d*d))),P={x:c.x+O*k,y:c.y+O*u};if(this.context.math.distance(e,P)<=v)return{rayId:i.id,handle:"move"}}}return null}onPointerDown(e){const s={x:e.x,y:e.y},r=this.snapPoint(this.context.canvas.screenToWorld(s)),o=this.findNearestHandle(s);if(o){const i=this.context.canvas.getObject(o.rayId),c=this.context.state.getState().selectedObjects;if(i&&c.includes(o.rayId)){this.state.currentRay=i,this.state.dragTarget=o.handle,this.state.isCreating=!1,o.handle==="move"&&(this.state.dragOffset={x:r.x-i.properties.startPoint.x,y:r.y-i.properties.startPoint.y});return}}if(!this.state.isCreating){this.state.isCreating=!0,this.state.startPoint=r;const i={id:this.generateId(),type:"ray",properties:{startPoint:r,endPoint:{...r},slope:0,yIntercept:r.y},visible:!0,selected:!1};this.state.currentRay=i,this.context.canvas.addObject(i)}}onPointerMove(e){if(!this.state.currentRay)return;const s={x:e.x,y:e.y},r=this.snapPoint(this.context.canvas.screenToWorld(s));if(this.state.isCreating){const o=this.context.math.slope(this.state.currentRay.properties.startPoint,r),i=r.y-o*r.x;this.context.canvas.updateObject(this.state.currentRay.id,{properties:{...this.state.currentRay.properties,endPoint:r,slope:o,yIntercept:isFinite(o)?i:this.state.currentRay.properties.startPoint.y}})}else if(this.state.dragTarget){const o=this.context.canvas.getObject(this.state.currentRay.id);if(!o)return;const i={...o.properties};if(this.state.dragTarget==="start")i.startPoint=r;else if(this.state.dragTarget==="end")i.endPoint=r;else if(this.state.dragTarget==="move"&&this.state.dragOffset){const c=r.x-this.state.dragOffset.x-o.properties.startPoint.x,l=r.y-this.state.dragOffset.y-o.properties.startPoint.y;i.startPoint={x:o.properties.startPoint.x+c,y:o.properties.startPoint.y+l},i.endPoint={x:o.properties.endPoint.x+c,y:o.properties.endPoint.y+l}}if(this.state.dragTarget==="start"||this.state.dragTarget==="end"){const c=this.context.math.slope(i.startPoint,i.endPoint);i.slope=c,i.yIntercept=isFinite(c)?i.startPoint.y-c*i.startPoint.x:i.startPoint.y}this.context.canvas.updateObject(this.state.currentRay.id,{properties:i})}this.context.events.emit("ray:update",{rayId:this.state.currentRay.id,ray:this.context.canvas.getObject(this.state.currentRay.id)})}onPointerUp(e){if(this.state.isCreating&&this.state.currentRay){const s={x:e.x,y:e.y},r=this.snapPoint(this.context.canvas.screenToWorld(s)),o=this.state.currentRay.properties.startPoint;this.context.math.distance(o,r)<.1?this.context.canvas.removeObject(this.state.currentRay.id):(this.context.events.emit("ray:created",{rayId:this.state.currentRay.id,ray:this.state.currentRay}),this.context.events.emit("tool:creation-complete",{toolId:this.id,objectId:this.state.currentRay.id}))}this.state={isCreating:!1,startPoint:null,currentRay:null,dragTarget:null,dragOffset:null}}}function Ne(){return new nt}class rt{constructor(){Q(this,"id","rectangle-tool");Q(this,"name","Rectangle Builder");Q(this,"context");Q(this,"state",{isCreating:!1,startPoint:null,currentRectangle:null,dragTarget:null,dragOffset:null,lockedCorner:null})}init(e){this.context=e,e.events.on("tool:changed",this.handleToolChange.bind(this)),e.events.on("tool:cancel",this.handleToolCancel.bind(this))}destroy(){this.context.events.off("tool:changed",this.handleToolChange.bind(this)),this.context.events.off("tool:cancel",this.handleToolCancel.bind(this))}handleToolChange(e){e.current!==this.id&&this.cancelCreation()}handleToolCancel(e){e.toolId===this.id&&this.cancelCreation()}cancelCreation(){this.state.currentRectangle&&this.state.isCreating&&this.context.canvas.removeObject(this.state.currentRectangle.id),this.state={isCreating:!1,startPoint:null,currentRectangle:null,dragTarget:null,dragOffset:null,lockedCorner:null}}generateId(){return`rect_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}snapPoint(e){const s=this.context.state.getState();if(s.snapToGrid){const r=s.viewport;let o;return r.zoom>=50?o=.1:r.zoom>=20?o=.25:r.zoom>=10?o=.5:o=s.gridDensity==="fine"?1:10,this.context.math.snapToGrid(e,o)}return e}findRectangleAtPoint(e){const s=this.context.canvas.getAllObjects();for(const r of s)if(r.type==="rectangle"){const o=r,{x:i,y:c,width:l,height:h}=o.properties;if(e.x>=i&&e.x<=i+l&&e.y>=c&&e.y<=c+h)return o}return null}findNearestCorner(e,s,r=.5){const{x:o,y:i,width:c,height:l}=s.properties,h=[{point:{x:o,y:i},type:"corner-bl"},{point:{x:o+c,y:i},type:"corner-br"},{point:{x:o,y:i+l},type:"corner-tl"},{point:{x:o+c,y:i+l},type:"corner-tr"}];for(const b of h)if(this.context.math.distance(e,b.point)<=r)return b.type;return null}onPointerDown(e){const s={x:e.x,y:e.y},r=this.snapPoint(this.context.canvas.screenToWorld(s)),o=this.findRectangleAtPoint(r);if(o&&this.context.state.getState().selectedObjects.includes(o.id)){const l=this.findNearestCorner(r,o);if(l){this.state.currentRectangle=o,this.state.dragTarget=l,this.state.isCreating=!1;const{x:h,y:b,width:v,height:k}=o.properties;switch(l){case"corner-tl":this.state.lockedCorner={x:h+v,y:b};break;case"corner-tr":this.state.lockedCorner={x:h,y:b};break;case"corner-bl":this.state.lockedCorner={x:h+v,y:b+k};break;case"corner-br":this.state.lockedCorner={x:h,y:b+k};break}return}else{this.state.currentRectangle=o,this.state.dragTarget="move",this.state.dragOffset={x:r.x-o.properties.x,y:r.y-o.properties.y},this.state.isCreating=!1;return}}this.state.isCreating=!0,this.state.startPoint=r;const i={id:this.generateId(),type:"rectangle",properties:{x:r.x,y:r.y,width:0,height:0,area:0},visible:!0,selected:!1};this.state.currentRectangle=i,this.context.canvas.addObject(i)}onPointerMove(e){if(!this.state.currentRectangle)return;const s={x:e.x,y:e.y},r=this.snapPoint(this.context.canvas.screenToWorld(s));if(this.state.isCreating&&this.state.startPoint){const o=Math.min(this.state.startPoint.x,r.x),i=Math.min(this.state.startPoint.y,r.y),c=Math.abs(r.x-this.state.startPoint.x),l=Math.abs(r.y-this.state.startPoint.y),h=c*l;this.context.canvas.updateObject(this.state.currentRectangle.id,{properties:{x:o,y:i,width:c,height:l,area:h}})}else if(this.state.dragTarget==="move"&&this.state.dragOffset){const o=r.x-this.state.dragOffset.x,i=r.y-this.state.dragOffset.y;this.context.canvas.updateObject(this.state.currentRectangle.id,{properties:{...this.state.currentRectangle.properties,x:o,y:i}})}else if(this.state.dragTarget&&this.state.dragTarget.startsWith("corner-")&&this.state.lockedCorner){const o=this.state.lockedCorner,i=Math.min(r.x,o.x),c=Math.max(r.x,o.x),l=Math.min(r.y,o.y),h=Math.max(r.y,o.y),b=i,v=l,k=c-i,u=h-l,d=Math.max(.1,k),O=Math.max(.1,u),P=d*O;this.context.canvas.updateObject(this.state.currentRectangle.id,{properties:{x:b,y:v,width:d,height:O,area:P}})}this.context.events.emit("rectangle:update",{rectangleId:this.state.currentRectangle.id,rectangle:this.context.canvas.getObject(this.state.currentRectangle.id)})}onPointerUp(e){if(this.state.isCreating&&this.state.currentRectangle){const s=this.context.canvas.getObject(this.state.currentRectangle.id);s&&(s.properties.width<.1||s.properties.height<.1?this.context.canvas.removeObject(this.state.currentRectangle.id):(this.context.events.emit("rectangle:created",{rectangleId:this.state.currentRectangle.id,rectangle:s}),this.context.events.emit("tool:creation-complete",{toolId:this.id,objectId:this.state.currentRectangle.id})))}this.state={isCreating:!1,startPoint:null,currentRectangle:null,dragTarget:null,dragOffset:null,lockedCorner:null}}}function De(){return new rt}class it{constructor(){Q(this,"id","area-counter");Q(this,"name","Area Counter");Q(this,"context");Q(this,"badges",new Map);Q(this,"badgeElements",new Map)}init(e){this.context=e,e.events.on("rectangle:created",this.handleRectangleCreated.bind(this)),e.events.on("rectangle:update",this.handleRectangleUpdated.bind(this)),e.events.on("object:removed",this.handleObjectRemoved.bind(this)),this.createBadgesForExistingRectangles();const s=e.state.subscribe(r=>{this.updateBadgePositions()});this.unsubscribeFromState=s}destroy(){this.context.events.off("rectangle:created",this.handleRectangleCreated.bind(this)),this.context.events.off("rectangle:update",this.handleRectangleUpdated.bind(this)),this.context.events.off("object:removed",this.handleObjectRemoved.bind(this)),this.unsubscribeFromState&&this.unsubscribeFromState(),this.badgeElements.forEach(e=>{e.remove()}),this.badgeElements.clear(),this.badges.clear()}createBadgesForExistingRectangles(){this.context.canvas.getAllObjects().forEach(s=>{s.type==="rectangle"&&this.createBadge(s)})}handleRectangleCreated(e){this.createBadge(e.rectangle)}handleRectangleUpdated(e){this.updateBadge(e.rectangle)}handleObjectRemoved(e){this.removeBadge(e.objectId)}createBadge(e){const s={rectangleId:e.id,x:e.properties.x,y:e.properties.y,width:e.properties.width,height:e.properties.height,area:e.properties.area,visible:!0};this.badges.set(e.id,s),this.createBadgeElement(s)}updateBadge(e){const s=this.badges.get(e.id);s&&(s.x=e.properties.x,s.y=e.properties.y,s.width=e.properties.width,s.height=e.properties.height,s.area=e.properties.area,this.updateBadgeElement(s))}removeBadge(e){const s=this.badgeElements.get(e);s&&(s.remove(),this.badgeElements.delete(e)),this.badges.delete(e)}createBadgeElement(e){const s=document.createElement("div");s.className="area-badge",s.style.cssText=`
      position: absolute;
      background: rgba(34, 197, 94, 0.9);
      color: white;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 600;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
      white-space: nowrap;
      pointer-events: none;
      z-index: 1000;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      border: 1px solid rgba(34, 197, 94, 1);
    `,(document.querySelector("[data-grix-canvas]")||document.body).appendChild(s),this.badgeElements.set(e.rectangleId,s),this.updateBadgeElement(e)}updateBadgeElement(e){const s=this.badgeElements.get(e.rectangleId);if(!s)return;const r=e.x+e.width/2,o=e.y+e.height/2,i=this.context.canvas.worldToScreen({x:r,y:o}),c=this.formatArea(e.area,e.width,e.height);s.textContent=c;const l=s.getBoundingClientRect();s.style.left=`${i.x-l.width/2}px`,s.style.top=`${i.y-l.height/2}px`;const h=this.context.state.getState(),b=30,v=e.width*h.viewport.zoom,k=e.height*h.viewport.zoom;s.style.display=v>=b&&k>=b?"block":"none"}formatArea(e,s,r){const o=Math.abs(s-Math.round(s))<.001,i=Math.abs(r-Math.round(r))<.001;if(o&&i){const c=Math.round(s),l=Math.round(r);return`${l} Ã— ${c} = ${l*c}`}return e>=1e3?`${e.toFixed(0)} sq units`:e>=10?`${e.toFixed(1)} sq units`:`${e.toFixed(2)} sq units`}updateBadgePositions(){this.badges.forEach(e=>{this.updateBadgeElement(e)})}showBadge(e){const s=this.badges.get(e);s&&(s.visible=!0,this.updateBadgeElement(s))}hideBadge(e){const s=this.badges.get(e);if(s){s.visible=!1;const r=this.badgeElements.get(e);r&&(r.style.display="none")}}showAllBadges(){this.badges.forEach((e,s)=>{this.showBadge(s)})}hideAllBadges(){this.badges.forEach((e,s)=>{this.hideBadge(s)})}}function ze(){return new it}function ot(){const{registerPlugin:t}=de(),e=g.useRef(!1);return g.useEffect(()=>{if(e.current)return;const s=Ne(),r=De(),o=ze();return t(s),t(r),t(o),e.current=!0,()=>{}},[t]),n.jsxs("div",{className:"flex flex-col h-screen bg-gray-50",children:[n.jsx(Ae,{}),n.jsx("div",{className:"flex-1 relative","data-grix-canvas":!0,children:n.jsx(ke,{width:window.innerWidth,height:window.innerHeight-60,className:"absolute inset-0"})})]})}function at(){return n.jsx(Te,{children:n.jsx(Me,{children:n.jsx(Te,{children:n.jsx(ot,{})})})})}const ct="0.1.0";q.Canvas=ke,q.GrixApp=at,q.PluginManagerProvider=Me,q.ToolBar=Ae,q.createAreaCounter=ze,q.createRayTool=Ne,q.createRectangleTool=De,q.useCanvasStore=V,q.useInputSystem=Pe,q.usePluginManager=de,q.version=ct,Object.defineProperty(q,Symbol.toStringTag,{value:"Module"})});
